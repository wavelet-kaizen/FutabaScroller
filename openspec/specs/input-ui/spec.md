# input-ui Specification

## Purpose
TBD - created by archiving change add-multi-thread-merge. Update Purpose after archive.
## Requirements
### Requirement: HTMLオーバーレイフォーム
システムは、prompt関数に代わりHTMLオーバーレイフォームで設定を入力させなければならない（SHALL）。

#### Scenario: フォーム表示
- **WHEN** ブックマークレットを実行する
- **THEN** システムは画面中央にオーバーレイフォームを表示する
- **AND** フォームには以下の入力項目が含まれる:
  - 開始位置の形式選択（ラジオボタン: レス番号/日時/No.）
  - 開始位置の値（テキスト入力）
  - 速度倍率（数値入力）
  - 追加スレッドURL（複数行テキストエリア）
  - 「開始」ボタンと「キャンセル」ボタン

#### Scenario: キャンセル
- **WHEN** ユーザーが「キャンセル」ボタンをクリックする
- **THEN** システムはオーバーレイを閉じ、ブックマークレットを終了する

#### Scenario: バリデーション失敗
- **WHEN** ユーザーが無効な値（速度倍率に負の数など）を入力して「開始」をクリックする
- **THEN** システムはフォーム内にエラーメッセージを表示し、再入力を促す
- **AND** オーバーレイは閉じない

### Requirement: 開始位置の形式選択
システムは、レス番号、日時、No.の3つの形式で開始位置を指定可能にしなければならない（SHALL）。

#### Scenario: レス番号指定
- **WHEN** ユーザーが開始位置形式として「レス番号」を選択し、値として `123` を入力して「開始」ボタンをクリックする
- **THEN** システムは `ThreadSettings.startMode = 'index'`, `startValue = 123` として処理する
- **AND** 形式バリデーション（値が正の整数であること）に成功した場合、マージ処理を開始する
- **AND** 範囲チェック（123番目のレスが存在するか）とタイムスタンプの解決は、マージ・ソート完了後に `resolveStartPosition()` で実施する

#### Scenario: 日時指定（2桁年+曜日付き形式）
- **WHEN** ユーザーが開始位置形式として「日時」を選択し、値として `'25/11/16(日)22:48:03'` を入力して「開始」ボタンをクリックする
- **THEN** システムは `ThreadSettings.startMode = 'timestamp'`, `startValue = '25/11/16(日)22:48:03'` として処理する
- **AND** 形式バリデーション（値が空でないこと）に成功した場合、マージ処理を開始する
- **AND** 日時のパースと開始時刻の解決は、マージ・ソート完了後に `resolveStartPosition()` で実施する
- **AND** 該当する日時のレスが存在しない場合でも、その時刻から再生を開始する（正常系として扱う）

#### Scenario: 日時指定（4桁年+曜日なし形式）
- **WHEN** ユーザーが開始位置形式として「日時」を選択し、値として `2025/11/16 22:48:03` を入力して「開始」ボタンをクリックする
- **THEN** システムは `ThreadSettings.startMode = 'timestamp'`, `startValue = '2025/11/16 22:48:03'` として処理する
- **AND** 形式バリデーション（値が空でないこと）に成功した場合、マージ処理を開始する
- **AND** 日時のパースと開始時刻の解決は、マージ・ソート完了後に `resolveStartPosition()` で実施する
- **AND** 該当する日時のレスが存在しない場合でも、その時刻から再生を開始する（正常系として扱う）

#### Scenario: No.指定
- **WHEN** ユーザーが開始位置形式として「No.」を選択し、値として `No.1373341055` を入力して「開始」ボタンをクリックする
- **THEN** システムは `ThreadSettings.startMode = 'no'`, `startValue = 'No.1373341055'` として処理する
- **AND** 形式バリデーション（値が空でないこと）に成功した場合、マージ処理を開始する
- **AND** No.の存在確認とタイムスタンプの解決は、マージ・ソート完了後に `resolveStartPosition()` で実施する

#### Scenario: 入力値の形式バリデーション
- **WHEN** ユーザーが「開始」ボタンをクリックする
- **THEN** システムは以下の形式バリデーションのみを実施する:
  - レス番号指定: 値が正の整数であること
  - 日時指定: 値が空でないこと（パース可能性はマージ後に検証）
  - No.指定: 値が空でないこと（存在確認はマージ後に検証）
  - 速度倍率: 正の数値であること
  - 追加スレッドURL: 各行が空またはURL形式であること
- **AND** 形式が無効な場合、フォーム内にエラーメッセージを表示し、再入力を促す
- **AND** 形式が有効な場合、マージ処理を開始する（範囲チェックや存在確認はマージ後に実施）

### Requirement: 追加スレッドURL入力
システムは、複数行テキストエリアで追加スレッドURLを入力可能にしなければならない（SHALL）。

#### Scenario: URL入力
- **WHEN** ユーザーがテキストエリアに以下を入力する:
  ```
  https://may.2chan.net/b/res/1111111111.htm
  https://may.2chan.net/b/res/2222222222.htm
  ```
- **THEN** システムは改行で分割し、空行を除外して2つのURLを抽出する
- **AND** `ThreadSettings.additionalThreadUrls = ['https://may.2chan.net/b/res/1111111111.htm', 'https://may.2chan.net/b/res/2222222222.htm']` として処理する

#### Scenario: URL未入力
- **WHEN** ユーザーが追加スレッドURLを入力しない（空のまま）
- **THEN** システムは `ThreadSettings.additionalThreadUrls = []` として処理し、現在のスレッドのみを対象とする

### Requirement: マージ後の開始位置解決失敗時のエラーハンドリング
システムは、マージ・ソート完了後に開始位置の解決が失敗した場合、フォームに戻して再入力させなければならない（SHALL）。

#### Scenario: レス番号範囲外エラー
- **WHEN** マージ・ソート完了後、ユーザーが指定したレス番号がマージ済み配列の範囲外である
- **THEN** システムはローディングオーバーレイを非表示にする
- **AND** 入力フォームを再表示し、直前の入力内容（開始位置形式、開始位置値、速度倍率、追加スレッドURL）を全て復元する
- **AND** 開始位置値の入力欄にエラーメッセージ「レス番号が範囲外です（1〜{マージ済み配列長}）」を表示する
- **AND** 他の入力項目は変更可能だが、デフォルト値は直前の入力内容とする

#### Scenario: No.未発見エラー
- **WHEN** マージ・ソート完了後、ユーザーが指定したNo.がマージ済みDOM内に存在しない
- **THEN** システムはローディングオーバーレイを非表示にする
- **AND** 入力フォームを再表示し、直前の入力内容を全て復元する
- **AND** 開始位置値の入力欄にエラーメッセージ「指定されたNo.が見つかりません」を表示する
- **AND** 他の入力項目は変更可能だが、デフォルト値は直前の入力内容とする

#### Scenario: 日時パース失敗エラー
- **WHEN** マージ・ソート完了後、ユーザーが指定した日時文字列がパース不可能である
- **THEN** システムはローディングオーバーレイを非表示にする
- **AND** 入力フォームを再表示し、直前の入力内容を全て復元する
- **AND** 開始位置値の入力欄にエラーメッセージ「日時形式が不正です（例: 25/11/16(日)22:48:03 または 2025/11/16 22:48:03）」を表示する
- **AND** 他の入力項目は変更可能だが、デフォルト値は直前の入力内容とする

#### Scenario: 再入力後の正常処理
- **WHEN** ユーザーがエラー表示されたフォームで開始位置値を修正し、「開始」ボタンをクリックする
- **THEN** システムは再度形式バリデーションとマージ処理を実施する
- **AND** マージ・ソート完了後、再度 `resolveStartPosition()` を呼び出して開始位置を解決する
- **AND** 今度は解決が成功した場合、StatusOverlayに「準備完了、xキーでスクロール開始」を表示する

_備考: 再入力時のマージ処理スキップ（DOM再利用）は、初回実装では対応せず、将来のパフォーマンス最適化として検討する。_

