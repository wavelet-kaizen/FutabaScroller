# Spec: モバイル向けタッチ操作UI

## ADDED Requirements

### Requirement: UI表示モード選択
入力フォームで、UIの表示動作を選択できる MUST。

#### Scenario: デフォルトは自動非表示モード
**Given** ユーザーが初めてブックマークレットを起動する
**When** 入力フォームが表示される
**Then** UI表示モードの選択肢は「自動非表示」がデフォルトで選択されている
**And** 「常駐表示」も選択可能

#### Scenario: 自動非表示モード選択時の動作
**Given** ユーザーが「自動非表示」モードを選択して開始する
**When** スクロールが開始される
**Then** 既存の動作と同じく、ステータスオーバーレイは5秒後に自動的に非表示になる
**And** キーボード操作（x, d, s）のみが有効

#### Scenario: 常駐表示モード選択時の動作
**Given** ユーザーが「常駐表示」モードを選択して開始する
**When** スクロールが開始される
**Then** 浮動コントロールパネルが画面右下に表示される
**And** パネルは自動的に非表示にならない
**And** キーボード操作（x, d, s）も引き続き有効

---

### Requirement: 浮動コントロールパネルの表示状態切り替え
常駐表示モード時、浮動コントロールパネルは3段階の表示状態を持つ MUST。

#### Scenario: 初期表示は最小化状態
**Given** 常駐表示モードでスクロールが開始される
**When** 浮動コントロールパネルが表示される
**Then** 初期状態は「最小化」（アイコンのみ、36x36px程度）である
**And** 画面右下の固定位置に配置される

#### Scenario: アイコンタップでステータス表示に切り替え
**Given** 浮動コントロールパネルが「最小化」状態で表示されている
**When** ユーザーがアイコンをタップする
**Then** 「ステータス表示」状態に切り替わる
**And** アイコンに加えて現在のスレッド日時、速度、再生/一時停止状態が表示される
**And** 表示領域は横長に拡大する（例: 200x40px程度）

#### Scenario: ステータス表示からフルコントロールに切り替え
**Given** 浮動コントロールパネルが「ステータス表示」状態で表示されている
**When** ユーザーがアイコンをタップする
**Then** 「フルコントロール」状態に切り替わる
**And** ステータス情報に加えて、再生/一時停止ボタン、速度+ボタン、速度-ボタンが表示される
**And** 表示領域はさらに拡大する（例: 200x80px程度）

#### Scenario: フルコントロールから最小化に戻る
**Given** 浮動コントロールパネルが「フルコントロール」状態で表示されている
**When** ユーザーがアイコンをタップする
**Then** 「最小化」状態に戻る
**And** アイコンのみが表示される

---

### Requirement: 浮動コントロールパネルのドラッグ移動
ユーザーは浮動コントロールパネルをドラッグして画面内の任意の位置に移動できる MUST。

#### Scenario: タッチドラッグで移動
**Given** 浮動コントロールパネルが表示されている
**When** ユーザーがパネルをタッチし、指を動かす
**Then** パネルは指の動きに追従して移動する
**And** 指を離すとその位置に固定される

#### Scenario: マウスドラッグで移動（PC環境）
**Given** 浮動コントロールパネルが表示されている
**When** ユーザーがパネルをマウスでドラッグする
**Then** パネルはマウスカーソルに追従して移動する
**And** マウスボタンを離すとその位置に固定される

#### Scenario: ドラッグ中は画面スクロールを抑制
**Given** ユーザーが浮動コントロールパネルをドラッグしている
**When** 指またはマウスカーソルが移動する
**Then** ページ全体のスクロールは発生しない
**And** パネルのみが移動する

#### Scenario: 画面外にはドラッグできない
**Given** ユーザーが浮動コントロールパネルをドラッグしている
**When** ドラッグ位置が画面の境界を超える
**Then** パネルは画面内に留まる
**And** 画面端でドラッグが制限される

---

### Requirement: フルコントロール状態での操作ボタン
フルコントロール状態では、タッチ操作で再生/一時停止、速度調整を実行できる MUST。

#### Scenario: 再生/一時停止ボタンをタップ
**Given** 浮動コントロールパネルが「フルコントロール」状態で表示されている
**And** スクロールが再生中である
**When** ユーザーが再生/一時停止ボタンをタップする
**Then** スクロールが一時停止する
**And** ボタンのアイコンが「再生」に変わる

#### Scenario: 一時停止中に再生ボタンをタップ
**Given** 浮動コントロールパネルが「フルコントロール」状態で表示されている
**And** スクロールが一時停止中である
**When** ユーザーが再生/一時停止ボタンをタップする
**Then** スクロールが再開する
**And** ボタンのアイコンが「一時停止」に変わる

#### Scenario: 速度+ボタンをタップ
**Given** 浮動コントロールパネルが「フルコントロール」状態で表示されている
**And** 現在の速度が1.0xである
**When** ユーザーが速度+ボタンをタップする
**Then** 速度が0.1増加して1.1xになる
**And** ステータス表示が「1.1x」に更新される

#### Scenario: 速度-ボタンをタップ
**Given** 浮動コントロールパネルが「フルコントロール」状態で表示されている
**And** 現在の速度が1.0xである
**When** ユーザーが速度-ボタンをタップする
**Then** 速度が0.1減少して0.9xになる
**And** ステータス表示が「0.9x」に更新される

#### Scenario: 速度の最小値制限
**Given** 現在の速度が0.1xである
**When** ユーザーが速度-ボタンをタップする
**Then** 速度は変化しない
**And** 0.1x未満にはならない

#### Scenario: 速度の最大値制限
**Given** 現在の速度が10.0xである
**When** ユーザーが速度+ボタンをタップする
**Then** 速度は変化しない
**And** 10.0xを超えない

---

### Requirement: ステータス情報のリアルタイム更新
浮動コントロールパネルのステータス表示は、スクロール状態に応じてリアルタイムで更新される MUST。

#### Scenario: スレッド日時の更新
**Given** 浮動コントロールパネルが「ステータス表示」または「フルコントロール」状態である
**When** スクロールが進行してスレッド日時が変化する
**Then** パネルのステータス表示に最新のスレッド日時が反映される
**And** フォーマットは「YYYY/MM/DD HH:MM:SS」である

#### Scenario: 速度変更の反映
**Given** 浮動コントロールパネルが「ステータス表示」または「フルコントロール」状態である
**When** ユーザーがキーボードまたはボタンで速度を変更する
**Then** パネルのステータス表示に新しい速度が反映される
**And** フォーマットは「X.Xx」（小数点第1位まで）である

#### Scenario: 再生/一時停止状態の反映
**Given** 浮動コントロールパネルが「ステータス表示」または「フルコントロール」状態である
**When** ユーザーがスクロールを一時停止する
**Then** パネルのステータス表示に「一時停止中」と表示される
**And** 再生時は「再生中」と表示される

#### Scenario: 準備完了メッセージの表示
**Given** 常駐表示モードで起動時に一時停止状態で開始される
**When** 準備が完了する
**Then** 浮動コントロールパネルに「準備完了、xキーでスクロール開始」と表示される
**And** メッセージは自動的に消えない（常駐表示）

#### Scenario: タイムライン終了メッセージの表示
**Given** 常駐表示モードでスクロールが進行中である
**When** 最後のレスの日時を超えてタイムラインが終了する
**Then** 浮動コントロールパネルに「タイムライン終了」と表示される
**And** スクロールが自動的に停止する
**And** メッセージは自動的に消えない（常駐表示）

#### Scenario: 開始位置解決エラーの表示
**Given** 常駐表示モードで開始位置解決に失敗する
**When** エラーが発生する（例: レス番号範囲外、No.未発見、日時パース失敗）
**Then** エラーメッセージは `window.alert` で表示される
**And** 浮動コントロールパネルには表示されない（コントローラ生成前のエラーのため）

---

### Requirement: 既存機能との共存
常駐表示モードでも、既存のキーボード操作は引き続き動作する MUST。

#### Scenario: キーボードで再生/一時停止
**Given** 常駐表示モードでスクロールが再生中である
**When** ユーザーがxキーを押す
**Then** スクロールが一時停止する
**And** 浮動コントロールパネルのステータス表示も「一時停止中」に更新される

#### Scenario: キーボードで速度調整
**Given** 常駐表示モードでスクロールが再生中である
**When** ユーザーがdキーを押す
**Then** 速度が0.1増加する
**And** 浮動コントロールパネルのステータス表示も更新される

#### Scenario: 既存のSpeedOverlayは無効化
**Given** 常駐表示モードでスクロールが開始される
**When** ユーザーが速度を変更する
**Then** 既存の `SpeedOverlay` は表示されない
**And** 速度情報は浮動コントロールパネルに統合される

#### Scenario: 既存のStatusOverlayは無効化
**Given** 常駐表示モードでスクロールが開始される
**When** 任意のステータス更新イベントが発生する
**Then** 既存の `StatusOverlay` は表示されない
**And** ステータス情報は浮動コントロールパネルに統合される

---

### Requirement: UIの破棄とクリーンアップ
スクロール終了時、浮動コントロールパネルは適切に破棄される MUST。

#### Scenario: スクロール停止時にUIを破棄
**Given** 常駐表示モードでスクロールが実行中である
**When** スクロールが停止される（`ScrollController.stop()` 呼び出し）
**Then** 浮動コントロールパネルがDOMから削除される
**And** イベントリスナーが解除される
**And** メモリリークが発生しない

#### Scenario: 再実行時のUI再生成
**Given** 浮動コントロールパネルが表示されている
**When** ユーザーがブックマークレットを再実行する
**Then** 既存のパネルが破棄される
**And** 新しいパネルが初期状態（最小化）で生成される
**And** 前回のドラッグ位置はリセットされる
