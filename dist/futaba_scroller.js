"use strict";(()=>{var R=class{getCurrentThreadTime(e,t){let r=Math.max(0,t-e.executionStartMs)*e.speedMultiplier;if(e.baselineThreadTime)return new Date(e.baselineThreadTime.getTime()+r);let i=e.threadStartTime.getTime()+r;return new Date(i)}findPreviousResponse(e,t){if(e.length===0)return null;let n=t.getTime(),r=[...e].sort((l,u)=>{let d=l.timestamp.getTime()-u.timestamp.getTime();return d!==0?d:l.index-u.index}),i=0,o=r.length-1,a=-1;for(;i<=o;){let l=Math.floor((i+o)/2);r[l].timestamp.getTime()<=n?(a=l,i=l+1):o=l-1}return a===-1?null:r[a]}};var ie=/^(\d{2})\/(\d{2})\/(\d{2})\((.)\)(\d{2}):(\d{2}):(\d{2})$/,oe=/^(\d{4})\/(\d{2})\/(\d{2}) (\d{2}):(\d{2}):(\d{2})$/,ae=["日","月","火","水","木","金","土"];function x(s,e={}){let t=s.trim(),n=t.match(ie);if(n){let[,i,o,a,l,u,d,m]=n,f=2e3+Number.parseInt(i,10);return V(f,Number.parseInt(o,10)-1,Number.parseInt(a,10),Number.parseInt(u,10),Number.parseInt(d,10),Number.parseInt(m,10),e.skipWeekdayCheck?null:l)}let r=t.match(oe);if(r){let[,i,o,a,l,u,d]=r;return V(Number.parseInt(i,10),Number.parseInt(o,10)-1,Number.parseInt(a,10),Number.parseInt(l,10),Number.parseInt(u,10),Number.parseInt(d,10))}return null}function V(s,e,t,n,r,i,o=null){if(Number.isNaN(s)||Number.isNaN(e)||Number.isNaN(t)||Number.isNaN(n)||Number.isNaN(r)||Number.isNaN(i))return null;let a=new Date(s,e,t,n,r,i,0);return a.getFullYear()!==s||a.getMonth()!==e||a.getDate()!==t||a.getHours()!==n||a.getMinutes()!==r||a.getSeconds()!==i||o&&ae[a.getDay()]!==o?null:a}function O(s){let e=5381;for(let t=0;t<s.length;t++)e=e*33^s.charCodeAt(t);return(e>>>0).toString(36)}function U(s,e){let t=s.textContent||"",r=`${e.toISOString()}:${t.substring(0,200)}`;return O(r)}var $={threadContainer:"body .thre",responseTimestamp:"body > div.thre table .cnw"};function y(s){return s&&s.nodeType===Node.ELEMENT_NODE?s:null}function le(s){let e=y(s);return e?e.tagName==="TABLE"?!0:e.tagName==="DIV"&&e.querySelector("table")!==null:!1}function B(s){return p(s,".cnw")!==null&&p(s,".cno")!==null}function p(s,e){for(let t of s){let n=y(t);if(!n)continue;if(n.matches(e))return n;let r=n.querySelector(e);if(r)return r}return null}function T(s){let e=[],t=[],n=()=>{t.length!==0&&(B(t)&&e.push(t),t=[])};return s.childNodes.forEach(r=>{if(le(r)){n(),B([r])&&e.push([r]);return}t.push(r)}),n(),e}function b(s,e=document){return s.map(t=>e.importNode(t,!0))}function N(s){let e=y(s.querySelector($.threadContainer));if(e)return e;let t=y(s.querySelector(".thre"));if(t)return t;let n=y(s.querySelector("[data-res]"));if(n)return n;let r=y(s.querySelector(".cnw"));if(r){let i=y(r.closest(".thre"));if(i)return i;let o=y(r.closest("body > div"));if(o)return o}return y(s.body)}function M(s=document){let e=N(s);if(!e)return console.warn("スレッドコンテナが見つかりません"),[];let t=T(e),n=[];return t.forEach((r,i)=>{let o=p(r,".cnw")?.textContent,a=o?pe(o):null;if(!a){console.warn(`レス#${i+1}: タイムスタンプが空です`);return}let l=x(a);if(!l){console.warn(`レス#${i+1}: タイムスタンプ解析に失敗: "${a}"`);return}let u=ue(r);if(!u){console.warn(`レス#${i+1}: アンカー要素が見つかりません`);return}n.push({timestamp:l,element:u,index:i+1,contentHash:de(r,l,u),allNodes:r})}),n}function ue(s){for(let t of s)if(t.nodeType===Node.ELEMENT_NODE)return t;let e=p(s,".cnw, .cno");return e||null}function de(s,e,t){if(s.length===1&&s[0]instanceof HTMLElement)return U(t,e);let n=ce(s),r=e.toISOString();return O(`${r}:${n}`)}function ce(s){return s.map(t=>t.textContent??"").join("|").slice(0,200)}function pe(s){let e=s.trim();return e.includes("ID:")?e.split("ID:")[0].trim():e}var me=1e4,he=5,I=class{constructor(e={}){this.intervalId=null;this.currentResponses=[];this.options={intervalMs:e.intervalMs??me,onResponsesAdded:e.onResponsesAdded??(()=>{}),onError:e.onError??(t=>console.error(t))}}start(){if(this.intervalId!==null){console.warn("ResponseUpdateManager is already running");return}try{this.currentResponses=M()}catch(e){this.options.onError(e instanceof Error?e:new Error("Failed to capture initial responses"));return}this.intervalId=window.setInterval(()=>this.update(),this.options.intervalMs)}stop(){this.intervalId!==null&&(window.clearInterval(this.intervalId),this.intervalId=null)}isRunning(){return this.intervalId!==null}getCurrentResponses(){return[...this.currentResponses]}update(){try{let e=M(),t=this.detectAddedResponses(this.currentResponses,e);this.currentResponses=e,t.length>0&&this.options.onResponsesAdded(t)}catch(e){this.options.onError(e instanceof Error?e:new Error("Failed to update responses"))}}detectAddedResponses(e,t){if(t.length<=e.length)return[];let n=Math.min(he,e.length),r=new Set(e.slice(-n).map(u=>this.makeIdentifier(u))),i=Math.max(0,e.length-n),o=t.slice(i),a=-1;for(let u=0;u<o.length;u++){let d=this.makeIdentifier(o[u]);if(!r.has(d)){a=i+u;break}}if(a===-1||a>=t.length)return t.slice(e.length);let l=Math.max(a,e.length);return t.slice(l)}makeIdentifier(e){return`${e.timestamp.getTime()}-${e.contentHash}`}};function q(s){if(!s)return"utf-8";let e=s.trim().toLowerCase();return e==="shift_jis"||e==="shift-jis"||e==="x-sjis"||e==="x-shift-jis"||e==="windows-31j"?"shift_jis":e||"utf-8"}function fe(s){let e=s.match(/<meta[^>]+charset=["']?([^"'>\s]+)/i);return e?.[1]?e[1]:s.match(/<meta[^>]+http-equiv=["']?content-type["']?[^>]*content=["'][^"']*charset=([^"'>\s]+)/i)?.[1]??null}function ye(s,e){let t=e?.match(/charset=([^;]+)/i)?.[1]??null;if(t)return q(t);let n=Math.min(s.byteLength,4096),r=new TextDecoder("utf-8",{fatal:!1}).decode(new Uint8Array(s,0,n)),i=fe(r);return i?q(i):"utf-8"}async function z(s){let e=await fetch(s);if(!e.ok)throw new Error(`スレッド ${s} を取得できませんでした (status: ${e.status})`);let t=await e.arrayBuffer(),n=ye(t,e.headers.get("content-type")),r;try{r=new TextDecoder(n).decode(t)}catch{r=new TextDecoder("utf-8").decode(t)}return new DOMParser().parseFromString(r,"text/html")}function Y(s){return(s.querySelector("title")?.textContent??"").toLowerCase().includes("futafuta")?"futafuta":Array.from(s.querySelectorAll("script[src]")).some(i=>i.getAttribute("src")?.includes("tsumanne.net"))||Array.from(s.querySelectorAll(".cnw")).some(i=>i.textContent?.includes("ID:"))?"tsumanne":s.querySelector(".thre > div > table")?"futaclo":"futaba"}function G(s,e){switch(e){case"futaba":return Te(s);case"futaclo":return ge(s);case"tsumanne":return Ee(s);case"futafuta":return ve(s);default:return[]}}function Te(s){let e=s.querySelector(".thre");return e?T(e).map(n=>b(n)):[]}function ge(s){let e=s.querySelector(".thre");return e?T(e).map(n=>b(n)):[]}function Ee(s){let e=s.querySelector(".thre");return e?T(e).filter(r=>{let i=r.find(o=>o instanceof HTMLElement&&o.tagName==="TABLE");return!(i instanceof HTMLElement&&i.classList.contains("deleted"))}).map(r=>{let i=b(r);return i.forEach(o=>{o instanceof HTMLElement&&Se(o)}),i}):[]}function Se(s){s.querySelectorAll(".cnw").forEach(t=>{let n=t.textContent??"";if(!n.includes("ID:"))return;let r=n.split("ID:")[0].trim();t.textContent=r})}function ve(s){let e=s.querySelector(".thre");return e?T(e).map(n=>b(n)):[]}async function K(s,e,t){if(s.length===0)return t.getCurrentResponses();let n=t.isRunning();t.stop(),e.show(s.length);try{let r=await xe(s,e);be(r);let i=M();return n&&t.start(),e.hide(),i}catch(r){let i=r instanceof Error?r.message:"スレッド取得中にエラーが発生しました。";throw e.showError(i),e.hide(),e.destroy(),n&&t.start(),r instanceof Error?r:new Error(i)}}async function xe(s,e){let t=[];for(let n=0;n<s.length;n+=1){let r=s[n],i=await z(r),o=Y(i),a=G(i,o);t.push(...a),e.updateProgress(n+1,s.length)}return t}function be(s){let e=N(document);if(!e)throw new Error("スレッドコンテナが見つかりません。");let t=T(e),n=new Set,r=[];t.forEach(a=>{let l=W(a);l!==null&&n.add(l),r.push({nodes:a,no:l})}),s.forEach(a=>{let l=W(a);l!==null&&n.has(l)||(l!==null&&n.add(l),r.push({nodes:a,no:l}))}),r.sort((a,l)=>a.no===null&&l.no===null?0:a.no===null?1:l.no===null?-1:a.no-l.no);let i=0;r.forEach(a=>{let l=Me(a.nodes),u=Re(a.nodes);if(l!==null){i=l;return}if(u!==null){i=u,j(a.nodes,u,!0);return}i+=1,j(a.nodes,i)});let o=r.flatMap(a=>a.nodes);e.replaceChildren(...o)}function W(s){let n=(p(s,".cno")?.textContent??"").match(/No\.(\d+)/);if(!n)return null;let r=Number.parseInt(n[1],10);return Number.isNaN(r)?null:r}function Me(s){let e=p(s,".res_no");if(!e)return null;let t=e.textContent??"",n=Number.parseInt(t,10);return Number.isNaN(n)?null:n}function Re(s){let e=p(s,".rsc");if(!e)return null;let t=e.textContent??"",n=Number.parseInt(t,10);return Number.isNaN(n)?null:n}function j(s,e,t=!1){let n=document.createElement("span");n.className="res_no",n.textContent=String(e),t&&(n.style.display="none");let r=p(s,".rtd");if(r){r.insertBefore(n,r.firstChild);return}let i=p(s,".cnw")??p(s,".cno");if(i&&i.parentElement){i.parentElement.insertBefore(n,i);return}if(s.length>0&&s[0]instanceof Element){s[0].insertBefore(n,s[0].firstChild);return}if(s.length>0&&s[0].nodeType===Node.TEXT_NODE){s.splice(1,0,n);return}s.unshift(n)}function L(s,e){if(s.startMode==="index"){let r=s.startResponseIndex;if(!Number.isInteger(r)||r<1)return g({type:"index_out_of_range",message:`レス番号が範囲外です（1〜${e.length}）`,validRange:{min:e.length>0?1:0,max:e.length}});let i=e.find(a=>{let l=Ie(a);return l!==null&&l===r});if(i)return w(i.timestamp);if(r>e.length)return g({type:"index_out_of_range",message:`レス番号が範囲外です（1〜${e.length}）`,validRange:{min:e.length>0?1:0,max:e.length}});let o=e.find(a=>a.index===r)??e[r-1];return o?w(o.timestamp):g({type:"index_out_of_range",message:`レス番号が範囲外です（1〜${e.length}）`,validRange:{min:e.length>0?1:0,max:e.length}})}if(s.startMode==="timestamp"){if(typeof s.startValue!="string")return g({type:"timestamp_parse_error",message:"日時形式が不正です（例: 25/11/16(日)22:48:03 または 2025/11/16 22:48:03）",inputValue:String(s.startValue)});let r=x(s.startValue,{skipWeekdayCheck:!0});return r?w(r):g({type:"timestamp_parse_error",message:"日時形式が不正です（例: 25/11/16(日)22:48:03 または 2025/11/16 22:48:03）",inputValue:s.startValue})}let t=X(s.startValue);if(t===null)return g({type:"no_not_found",message:"指定されたNo.が見つかりません",searchedNo:String(s.startValue)});let n=e.find(r=>{let i=Ne(r),o=i?X(i):null;return o!==null&&o===t});return n?w(n.timestamp):g({type:"no_not_found",message:"指定されたNo.が見つかりません",searchedNo:typeof s.startValue=="string"?s.startValue:`No.${t}`})}function Ne(s){let e=s.element.querySelector(".cno")?.textContent?.trim();if(e)return e;if(!s.allNodes)return null;for(let t of s.allNodes)if(t.nodeType===Node.ELEMENT_NODE){let n=t;if(n.classList.contains("cno"))return n.textContent?.trim()??null;let r=n.querySelector(".cno");if(r?.textContent)return r.textContent.trim()}return null}function X(s){if(typeof s=="number")return Number.isInteger(s)?s:null;let e=s.trim().match(/No\.(\d+)/);if(!e)return null;let t=Number.parseInt(e[1],10);return Number.isNaN(t)?null:t}function Ie(s){let e=s.element.querySelector(".res_no")?.textContent?.trim(),t=e?Number.parseInt(e,10):NaN;if(!Number.isNaN(t))return t;if(s.allNodes){for(let n of s.allNodes)if(n instanceof HTMLElement){let r=n.querySelector(".res_no");if(r?.textContent){let i=Number.parseInt(r.textContent.trim(),10);if(!Number.isNaN(i))return i}}}return null}function w(s){return{success:!0,value:s}}function g(s){return{success:!1,error:s}}function C(s){return{success:!1,error:s}}function Z(s){return{success:!0,value:s}}function J(s){return Number.isFinite(s)?s<=0?C({code:"SPEED_MULTIPLIER_NON_POSITIVE",message:"再生速度は0より大きい数値で指定してください。",input:s}):Z(s):C({code:"SPEED_MULTIPLIER_NOT_FINITE",message:"再生速度は有限の数値で指定してください。",input:s})}function Q(s){let e=s.trim();try{let t=new URL(e);return t.protocol!=="http:"&&t.protocol!=="https:"?C({code:"URL_INVALID_FORMAT",message:"URLは http または https で入力してください。",input:s}):Z(t.toString())}catch{return C({code:"URL_INVALID_FORMAT",message:"有効なURLを入力してください。",input:s})}}var we=1e4,Le="420px",E="1px solid #444",D=class{constructor(){this.container=null;this.resolveFn=null;this.lastSettings=null}async prompt(e){e();let t=this.lastSettings??this.getDefaultSettings();return this.render(t)}async showWithError(e,t,n){return this.render(e,{message:t,field:n})}destroy(){this.container&&(this.container.remove(),this.container=null),this.resolveFn=null}async render(e,t){if(this.destroy(),!document.body)return null;this.lastSettings=e;let{overlay:n,form:r,errorBox:i}=this.createOverlay(e);return document.body.appendChild(n),t&&this.showError(r,i,t.message,t.field),new Promise(o=>{this.resolveFn=o})}getDefaultSettings(){return{startMode:"index",startValue:1,startResponseIndex:1,speedMultiplier:1,additionalThreadUrls:[]}}createOverlay(e){let t=document.createElement("div");t.dataset.role="input-form-overlay",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.background="rgba(0, 0, 0, 0.6)",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.zIndex=String(we);let n=document.createElement("div");n.dataset.role="input-form-card",n.style.background="#222",n.style.color="#fff",n.style.padding="20px",n.style.borderRadius="8px",n.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.5)",n.style.width=Le,n.style.fontFamily="sans-serif",n.style.boxSizing="border-box";let r=document.createElement("h2");r.textContent="Futaba Scroller 設定",r.style.margin="0 0 12px",r.style.fontSize="18px";let i=document.createElement("p");i.textContent="開始位置、速度、追加スレッドURLを入力してください。",i.style.margin="0 0 16px",i.style.fontSize="13px",i.style.color="#ddd";let o=document.createElement("form");o.dataset.role="input-form",o.style.display="flex",o.style.flexDirection="column",o.style.gap="12px";let a=this.createStartModeField(e.startMode),l=this.createStartValueField(e),u=this.createSpeedField(e.speedMultiplier),d=this.createAdditionalUrlField(e.additionalThreadUrls),m=this.createErrorBox(),f=this.createActionButtons();o.appendChild(a),o.appendChild(l),o.appendChild(u),o.appendChild(d),o.appendChild(m),o.appendChild(f),o.addEventListener("submit",h=>{h.preventDefault(),this.resetErrorStyles(o,m);let v=this.collectSettings(o);if(!v.success){this.showError(o,m,v.error.message,v.error.field);return}this.lastSettings=v.value,this.resolve(v.value)}),f.querySelector('[data-role="cancel-button"]')?.addEventListener("click",h=>{h.preventDefault(),this.resolve(null)});let k=o.querySelectorAll('input[name="startMode"]'),c=o.querySelector('[data-role="start-value"]');return k.forEach(h=>{h.addEventListener("change",()=>{c&&(c.value=this.getStartValueDefault(h.value),c.placeholder=this.getStartValuePlaceholder(h.value))})}),t.appendChild(n),n.appendChild(r),n.appendChild(i),n.appendChild(o),this.container=t,{overlay:t,form:o,errorBox:m}}createStartModeField(e){let t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.gap="6px";let n=document.createElement("div");n.textContent="開始位置の指定方法",n.style.fontWeight="bold",n.style.fontSize="14px";let r=document.createElement("div");return r.style.display="flex",r.style.gap="12px",[{value:"index",label:"レス番号"},{value:"timestamp",label:"日時"},{value:"no",label:"No."}].forEach(o=>{let a=document.createElement("label");a.style.display="flex",a.style.alignItems="center",a.style.gap="6px",a.style.fontSize="13px";let l=document.createElement("input");l.type="radio",l.name="startMode",l.value=o.value,l.checked=o.value===e,a.appendChild(l),a.appendChild(document.createTextNode(o.label)),r.appendChild(a)}),t.appendChild(n),t.appendChild(r),t}createStartValueField(e){let t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.gap="6px";let n=document.createElement("label");n.textContent="開始位置の値",n.style.fontWeight="bold",n.style.fontSize="14px";let r=document.createElement("input");return r.type="text",r.dataset.role="start-value",r.value=this.getStartValueString(e),r.placeholder=this.getStartValuePlaceholder(e.startMode),r.style.padding="8px",r.style.borderRadius="4px",r.style.border=E,r.style.background="#111",r.style.color="#fff",r.style.fontSize="14px",t.appendChild(n),t.appendChild(r),t}createSpeedField(e){let t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.gap="6px";let n=document.createElement("label");n.textContent="速度倍率",n.style.fontWeight="bold",n.style.fontSize="14px";let r=document.createElement("input");return r.type="number",r.step="0.1",r.min="0.1",r.value=String(e),r.dataset.role="speed",r.style.padding="8px",r.style.borderRadius="4px",r.style.border=E,r.style.background="#111",r.style.color="#fff",r.style.fontSize="14px",t.appendChild(n),t.appendChild(r),t}createAdditionalUrlField(e){let t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.gap="6px";let n=document.createElement("label");n.textContent="追加スレッドURL（改行区切り、任意）",n.style.fontWeight="bold",n.style.fontSize="14px";let r=document.createElement("textarea");return r.rows=4,r.dataset.role="additional-urls",r.placeholder="https://may.2chan.net/b/res/1234567890.htm",r.value=e.join(`
`),r.style.padding="8px",r.style.borderRadius="4px",r.style.border=E,r.style.background="#111",r.style.color="#fff",r.style.fontSize="13px",r.style.resize="vertical",t.appendChild(n),t.appendChild(r),t}createErrorBox(){let e=document.createElement("div");return e.dataset.role="input-error",e.style.display="none",e.style.background="rgba(255, 87, 87, 0.1)",e.style.color="#ff8787",e.style.border="1px solid rgba(255, 87, 87, 0.4)",e.style.padding="8px",e.style.borderRadius="4px",e.style.fontSize="13px",e}createActionButtons(){let e=document.createElement("div");e.style.display="flex",e.style.justifyContent="flex-end",e.style.gap="12px";let t=document.createElement("button");t.type="button",t.textContent="キャンセル",t.dataset.role="cancel-button",t.style.padding="8px 12px",t.style.borderRadius="4px",t.style.border="1px solid #555",t.style.background="#333",t.style.color="#fff",t.style.cursor="pointer";let n=document.createElement("button");return n.type="submit",n.textContent="開始",n.dataset.role="submit-button",n.style.padding="8px 12px",n.style.borderRadius="4px",n.style.border="1px solid #5aa0ff",n.style.background="#2d6bff",n.style.color="#fff",n.style.cursor="pointer",e.appendChild(t),e.appendChild(n),e}collectSettings(e){let t=e.elements.namedItem("startMode"),n="index";(t instanceof RadioNodeList||t instanceof HTMLInputElement)&&(n=t.value||"index");let r=e.querySelector('[data-role="start-value"]'),i=e.querySelector('[data-role="speed"]'),o=e.querySelector('[data-role="additional-urls"]');if(!r||!i||!o)return{success:!1,error:{message:"フォーム要素の取得に失敗しました。",field:"startValue"}};let a=r.value.trim(),l=Number(i.value),u=o.value,d=J(l);if(!d.success)return{success:!1,error:{message:d.error.message,field:"speedMultiplier"}};let m=1,f=a;if(n==="index"){let c=Number(a);if(!Number.isInteger(c)||c<1)return{success:!1,error:{message:"レス番号は1以上の整数で入力してください。",field:"startValue"}};m=c,f=c}else if(n==="timestamp"){if(a.length===0)return{success:!1,error:{message:"日時を入力してください。",field:"startValue"}};f=a}else if(n==="no"){if(a.length===0)return{success:!1,error:{message:"No.を入力してください。",field:"startValue"}};f=a}let F=[],k=u.split(/\r?\n/).map(c=>c.trim()).filter(c=>c.length>0);for(let c of k){let h=Q(c);if(!h.success)return{success:!1,error:{message:h.error.message,field:"urls"}};F.push(h.value)}return{success:!0,value:{startMode:n,startValue:f,startResponseIndex:m,speedMultiplier:d.value,additionalThreadUrls:F}}}showError(e,t,n,r){this.resetErrorStyles(e,t);let i=this.getFieldElement(e,r);i&&(i.style.border="1px solid #ff8787"),t.textContent=n,t.style.display="block"}resetErrorStyles(e,t){t.style.display="none",t.textContent="";let n=this.getFieldElement(e,"startValue"),r=this.getFieldElement(e,"speedMultiplier"),i=this.getFieldElement(e,"urls");n&&(n.style.border=E),r&&(r.style.border=E),i&&(i.style.border=E)}getFieldElement(e,t){return t==="startValue"?e.querySelector('[data-role="start-value"]'):t==="speedMultiplier"?e.querySelector('[data-role="speed"]'):e.querySelector('[data-role="additional-urls"]')}resolve(e){let t=this.resolveFn;this.resolveFn=null,this.destroy(),t?.(e)}getStartValueDefault(e){return e==="timestamp"?"":e==="no"?"No.":"1"}getStartValuePlaceholder(e){return e==="timestamp"?"25/11/16(日)22:48:03 または 2025/11/16 22:48:03":e==="no"?"No.1373341055":"1"}getStartValueString(e){return e.startMode==="index"?String(typeof e.startValue=="number"?e.startValue:e.startResponseIndex||1):typeof e.startValue=="string"?e.startValue:""}};var ee="fs-loading-spin",te=!1,_=class{constructor(){this.container=null;this.messageElement=null;this.errorElement=null;this.totalCount=0;this.currentCount=0}show(e){if(this.totalCount=e,this.currentCount=0,this.ensureStyles(),!document.body){console.warn("document.body が見つかりません。");return}this.container||(this.container=this.createContainer(),document.body.appendChild(this.container)),this.updateMessage(),this.container.style.display="flex"}hide(){this.container&&(this.container.style.display="none")}destroy(){this.container&&(this.container.remove(),this.container=null),this.messageElement=null,this.errorElement=null,this.totalCount=0,this.currentCount=0}updateProgress(e,t){Number.isFinite(t)&&(this.totalCount=t),this.currentCount=e,this.updateMessage()}showError(e){this.container||this.show(this.totalCount||0),this.container&&(this.container.style.display="flex"),this.errorElement&&(this.errorElement.textContent=e,this.errorElement.style.display="block")}updateMessage(){if(!this.messageElement)return;let e=this.totalCount>1?` (${this.currentCount}/${this.totalCount})`:"";this.messageElement.textContent=`スレッド取得中...${e}`}createContainer(){let e=document.createElement("div");e.dataset.role="loading-overlay",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.background="rgba(0, 0, 0, 0.6)",e.style.display="none",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex=String(10001);let t=document.createElement("div");t.style.background="#222",t.style.color="#fff",t.style.padding="20px",t.style.borderRadius="8px",t.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.5)",t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="center",t.style.gap="12px",t.style.fontFamily="sans-serif";let n=document.createElement("div");n.dataset.role="loading-spinner",n.style.width="32px",n.style.height="32px",n.style.border="4px solid rgba(255, 255, 255, 0.3)",n.style.borderTop="4px solid #5aa0ff",n.style.borderRadius="50%",n.style.animation=`${ee} 1s linear infinite`;let r=document.createElement("div");r.dataset.role="loading-message",r.style.fontSize="14px",r.style.textAlign="center",r.textContent="スレッド取得中...",this.messageElement=r;let i=document.createElement("div");return i.dataset.role="loading-error",i.style.display="none",i.style.color="#ff8787",i.style.fontSize="13px",i.style.textAlign="center",i.style.maxWidth="320px",this.errorElement=i,t.appendChild(n),t.appendChild(r),t.appendChild(i),e.appendChild(t),e}ensureStyles(){if(te||!document.head)return;let e=document.createElement("style");e.textContent=`
@keyframes ${ee} {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}`,document.head.appendChild(e),te=!0}};function ne(s){s.scrollIntoView({behavior:"smooth",block:"start"})}var P=class{constructor(){this.container=null;this.hideTimer=null}show(e){if(!this.container){if(!document.body){console.warn("document.body が見つかりません。");return}this.container=this.createContainer(),document.body.appendChild(this.container)}this.container.textContent=`倍速: ${e.toFixed(1)}x`,this.container.style.display="block",this.hideTimer!==null&&window.clearTimeout(this.hideTimer),this.hideTimer=window.setTimeout(()=>{this.hideTimer=null,this.hide()},2e3)}hide(){this.container&&(this.container.style.display="none")}destroy(){this.hideTimer!==null&&(window.clearTimeout(this.hideTimer),this.hideTimer=null),this.container&&(this.container.remove(),this.container=null)}createContainer(){let e=document.createElement("div");return e.dataset.role="speed-overlay",e.style.position="fixed",e.style.top="12px",e.style.left="12px",e.style.padding="8px 12px",e.style.background="rgba(0, 0, 0, 0.7)",e.style.color="#fff",e.style.fontSize="14px",e.style.fontFamily="sans-serif",e.style.borderRadius="4px",e.style.zIndex="9999",e.style.display="none",e.style.pointerEvents="none",e}};var Ce="[再生中] ----/--/-- --:--:-- | 0.0x",De="24px",_e="12px";var A=class{constructor(){this.container=null;this.hasWarnedAboutBody=!1;this.hideTimeoutId=null;this.latestThreadTime=null;this.latestSpeed=0;this.latestPaused=!1}updateState(e,t,n){this.latestThreadTime=e,this.latestSpeed=t,this.latestPaused=n;let r=this.ensureContainer();r&&(r.textContent=this.composeStatusText())}showTemporarily(){let e=this.ensureContainer();e&&(e.textContent=this.composeStatusText(),e.style.display="block",this.clearHideTimer(),this.hideTimeoutId=window.setTimeout(()=>{e.style.display="none",this.hideTimeoutId=null},5e3))}showMessage(e){let t=this.ensureContainer();t&&(t.textContent=e,t.style.display="block",this.clearHideTimer(),this.hideTimeoutId=window.setTimeout(()=>{t.style.display="none",this.hideTimeoutId=null},5e3))}destroy(){this.clearHideTimer(),this.container&&(this.container.remove(),this.container=null),this.latestThreadTime=null,this.hasWarnedAboutBody=!1}ensureContainer(){return document.body?(this.container||(this.container=this.createContainer(),document.body.appendChild(this.container)),this.hasWarnedAboutBody=!1,this.container):(this.hasWarnedAboutBody||(console.warn("document.body が見つかりません"),this.hasWarnedAboutBody=!0),null)}createContainer(){let e=document.createElement("div");return e.dataset.role="status-overlay",e.style.position="fixed",e.style.bottom=De,e.style.left=_e,e.style.padding="8px 12px",e.style.background="rgba(0, 0, 0, 0.7)",e.style.color="#fff",e.style.fontSize="14px",e.style.fontFamily="sans-serif",e.style.borderRadius="4px",e.style.zIndex="9999",e.style.pointerEvents="none",e.style.display="none",e.textContent=Ce,e}composeStatusText(){let e=this.latestPaused?"一時停止中":"再生中",t=this.latestThreadTime?this.formatDate(this.latestThreadTime):"----/--/-- --:--:--";return`[${e}] ${t} | ${this.latestSpeed.toFixed(1)}x`}clearHideTimer(){this.hideTimeoutId!==null&&(window.clearTimeout(this.hideTimeoutId),this.hideTimeoutId=null)}formatDate(e){let t=e.getFullYear().toString().padStart(4,"0"),n=(e.getMonth()+1).toString().padStart(2,"0"),r=e.getDate().toString().padStart(2,"0"),i=e.getHours().toString().padStart(2,"0"),o=e.getMinutes().toString().padStart(2,"0"),a=e.getSeconds().toString().padStart(2,"0");return`${t}/${n}/${r} ${i}:${o}:${a}`}};var Pe=500,Ae=.1,He=10,re=.1;var H=class{constructor(e,t,n,r=ne,i){this.responses=e;this.settings=t;this.timeline=n;this.scrollFn=r;this.onError=i;this.intervalId=null;this.executionStartMs=null;this.baselineThreadTime=null;this.speedOverlay=new P;this.statusOverlay=new A;this.keydownHandler=null;this.playbackState="STOPPED";this.currentThreadTime=null;this.startThreadTime=null;this.hasScrolledInitial=!1;this.lastResponseTimestamp=null;this.timelineEnded=!1;this.timelineResponses=e.map(o=>({timestamp:o.timestamp,index:o.index})),this.responseMap=new Map(e.map(o=>[o.index,o])),this.speedMultiplier=t.speedMultiplier,this.lastResponseTimestamp=this.getLastResponseTimestamp()}start(e={}){this.intervalId!==null&&this.stop();let t=e.startTime?{success:!0,value:e.startTime}:L(this.settings,this.responses);if(!t.success){console.error(t.error.message),this.onError?.(t.error.message);return}this.startThreadTime=t.value,this.currentThreadTime=t.value,this.executionStartMs=e.startPaused?null:Date.now(),this.baselineThreadTime=null,this.speedMultiplier=this.settings.speedMultiplier,this.hasScrolledInitial=!1,this.timelineEnded=!1,this.playbackState=e.startPaused?"PAUSED":"PLAYING",this.updateStatusOverlay(!0),e.startPaused&&this.statusOverlay.showMessage("準備完了、xキーでスクロール開始"),this.lastResponseTimestamp=this.getLastResponseTimestamp(),this.tick(),this.intervalId=window.setInterval(()=>this.tick(),Pe),this.bindKeyboard()}stop(){this.intervalId!==null&&(window.clearInterval(this.intervalId),this.intervalId=null),this.executionStartMs=null,this.baselineThreadTime=null,this.unbindKeyboard(),this.speedOverlay.destroy(),this.statusOverlay.destroy(),this.playbackState="STOPPED",this.currentThreadTime=null,this.startThreadTime=null,this.hasScrolledInitial=!1,this.timelineEnded=!1}isRunning(){return this.playbackState!=="STOPPED"&&!this.timelineEnded}tick(){if(!this.startThreadTime)return;if(this.playbackState!=="PAUSED"&&this.executionStartMs!==null){let n={threadStartTime:this.startThreadTime,executionStartMs:this.executionStartMs,speedMultiplier:this.speedMultiplier,baselineThreadTime:this.baselineThreadTime??void 0},r=this.timeline.getCurrentThreadTime(n,Date.now());this.currentThreadTime=r}else this.currentThreadTime||(this.currentThreadTime=this.startThreadTime);if(this.updateStatusOverlay(),!this.currentThreadTime)return;if(this.lastResponseTimestamp&&this.currentThreadTime.getTime()>this.lastResponseTimestamp.getTime()){this.handleTimelineEnd();return}if(this.playbackState==="PAUSED"||this.executionStartMs===null)return;let e=this.timeline.findPreviousResponse(this.timelineResponses,this.currentThreadTime);if(!e)return;if(!this.hasScrolledInitial&&this.settings.startMode==="index"){let n=this.responseMap.get(this.settings.startResponseIndex);if(n){this.scrollFn(n.element),this.hasScrolledInitial=!0;return}}let t=this.responseMap.get(e.index);if(!t){console.error(`レス番号${e.index}に対応する要素が見つかりません。`);return}this.scrollFn(t.element)}handleTimelineEnd(){if(this.timelineEnded)return;this.timelineEnded=!0;let e=this.responses.length>0?this.responses[this.responses.length-1]:null;e&&(this.currentThreadTime=e.timestamp,this.scrollFn(e.element)),this.intervalId!==null&&(window.clearInterval(this.intervalId),this.intervalId=null),this.executionStartMs=null,this.playbackState="PAUSED",this.updateStatusOverlay(!0),this.statusOverlay.showMessage("タイムライン終了"),this.unbindKeyboard()}bindKeyboard(){this.keydownHandler&&window.removeEventListener("keydown",this.keydownHandler),this.keydownHandler=e=>{let t=e.target;if(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement||t instanceof HTMLSelectElement||t instanceof HTMLElement&&t.isContentEditable)return;let n=e.key.toLowerCase();n==="d"?this.adjustSpeed(re):n==="s"?this.adjustSpeed(-re):n==="x"&&this.togglePause()},window.addEventListener("keydown",this.keydownHandler)}unbindKeyboard(){this.keydownHandler&&(window.removeEventListener("keydown",this.keydownHandler),this.keydownHandler=null)}adjustSpeed(e){if(this.executionStartMs===null&&this.playbackState!=="PAUSED")return;let t=Number((this.speedMultiplier+e).toFixed(1)),n=Math.min(He,Math.max(Ae,t));if(n===this.speedMultiplier||!this.startThreadTime)return;if(this.playbackState==="PAUSED"||this.executionStartMs===null){this.speedMultiplier=n,this.speedOverlay.show(this.speedMultiplier),this.updateStatusOverlay(!0);return}let r={threadStartTime:this.startThreadTime,executionStartMs:this.executionStartMs,speedMultiplier:this.speedMultiplier,baselineThreadTime:this.baselineThreadTime??void 0},i=this.timeline.getCurrentThreadTime(r,Date.now());this.baselineThreadTime=i,this.currentThreadTime=i,this.executionStartMs=Date.now(),this.speedMultiplier=n,this.speedOverlay.show(this.speedMultiplier),this.updateStatusOverlay(!0)}pause(){if(this.playbackState==="PLAYING"&&this.startThreadTime){if(this.executionStartMs!==null){let e={threadStartTime:this.startThreadTime,executionStartMs:this.executionStartMs,speedMultiplier:this.speedMultiplier,baselineThreadTime:this.baselineThreadTime??void 0},t=this.timeline.getCurrentThreadTime(e,Date.now());this.baselineThreadTime=t,this.currentThreadTime=t}this.executionStartMs=null,this.playbackState="PAUSED",this.updateStatusOverlay(!0)}}resume(){this.playbackState==="PAUSED"&&(this.executionStartMs=Date.now(),this.playbackState="PLAYING",this.updateStatusOverlay(!0))}togglePause(){this.playbackState==="PAUSED"?this.resume():this.pause()}updateStatusOverlay(e=!1){this.statusOverlay.updateState(this.currentThreadTime,this.speedMultiplier,this.playbackState==="PAUSED"),e&&this.statusOverlay.showTemporarily()}getLastResponseTimestamp(){if(this.responses.length===0)return null;let e=this.responses[0].timestamp;for(let t of this.responses)t.timestamp.getTime()>e.getTime()&&(e=t.timestamp);return e}appendResponses(e){if(e.length===0)return;this.responses.push(...e);let t=e.map(n=>({timestamp:n.timestamp,index:n.index}));this.timelineResponses.push(...t);for(let n of e)this.responseMap.set(n.index,n);this.lastResponseTimestamp=this.getLastResponseTimestamp()}};var S=class extends Error{};async function se(){let s=new D,e=new _,t=null,n=null;try{n=new I({intervalMs:1e4,onResponsesAdded:o=>{t&&t.appendResponses(o)},onError:o=>{console.error("レス更新エラー:",o)}}),n.start();let r=n.getCurrentResponses();if(r.length===0)throw n.stop(),new S("レスが見つかりませんでした。");let i=await s.prompt(()=>n?n.getCurrentResponses().length:r.length);for(;i;){let o=n.getCurrentResponses();if(i.additionalThreadUrls.length>0)try{o=await K(i.additionalThreadUrls,e,n)}catch(d){n.stop();let m=d instanceof Error?d.message:"スレッドの取得に失敗しました。";throw new S(m)}if(o.length===0)throw n.stop(),new S("レスが見つかりませんでした。");let a=L(i,o);if(!a.success){i=await s.showWithError(i,a.error.message,"startValue");continue}let l=new R,u=n.getCurrentResponses();return t=new H(i.additionalThreadUrls.length>0?o:u,i,l,void 0,d=>window.alert(d)),t.start({startPaused:!0,startTime:a.value}),{controller:t,updateManager:n}}return n.stop(),null}catch(r){return n?.stop(),r instanceof S?(window.alert(r.message),null):(console.error("予期しないエラーが発生しました。",r),window.alert("エラーが発生しました。コンソールを確認してください。"),null)}}(async function(){window.__FUTABA_SCROLLER__&&(window.__FUTABA_SCROLLER__.controller.stop(),window.__FUTABA_SCROLLER__.updateManager.stop());let e=await se();e&&(window.__FUTABA_SCROLLER__=e)})().catch(s=>{console.error("FutabaScroller起動エラー:",s)});})();
