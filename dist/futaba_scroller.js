"use strict";(()=>{var w=class{getCurrentThreadTime(e,t){let s=Math.max(0,t-e.executionStartMs)*e.speedMultiplier;if(e.baselineThreadTime)return new Date(e.baselineThreadTime.getTime()+s);let i=e.threadStartTime.getTime()+s;return new Date(i)}findPreviousResponse(e,t){if(e.length===0)return null;let n=t.getTime(),s=[...e].sort((l,d)=>{let u=l.timestamp.getTime()-d.timestamp.getTime();return u!==0?u:l.index-d.index}),i=0,a=s.length-1,o=-1;for(;i<=a;){let l=Math.floor((i+a)/2);s[l].timestamp.getTime()<=n?(o=l,i=l+1):a=l-1}return o===-1?null:s[o]}};var le=/^(\d{2})\/(\d{2})\/(\d{2})\((.)\)(\d{2}):(\d{2}):(\d{2})$/,de=/^(\d{4})\/(\d{2})\/(\d{2}) (\d{2}):(\d{2}):(\d{2})$/,ue=["日","月","火","水","木","金","土"];function b(r,e={}){let t=r.trim(),n=t.match(le);if(n){let[,i,a,o,l,d,u,h]=n,c=2e3+Number.parseInt(i,10);return $(c,Number.parseInt(a,10)-1,Number.parseInt(o,10),Number.parseInt(d,10),Number.parseInt(u,10),Number.parseInt(h,10),e.skipWeekdayCheck?null:l)}let s=t.match(de);if(s){let[,i,a,o,l,d,u]=s;return $(Number.parseInt(i,10),Number.parseInt(a,10)-1,Number.parseInt(o,10),Number.parseInt(l,10),Number.parseInt(d,10),Number.parseInt(u,10))}return null}function $(r,e,t,n,s,i,a=null){if(Number.isNaN(r)||Number.isNaN(e)||Number.isNaN(t)||Number.isNaN(n)||Number.isNaN(s)||Number.isNaN(i))return null;let o=new Date(r,e,t,n,s,i,0);return o.getFullYear()!==r||o.getMonth()!==e||o.getDate()!==t||o.getHours()!==n||o.getMinutes()!==s||o.getSeconds()!==i||a&&ue[o.getDay()]!==a?null:o}function U(r){let e=5381;for(let t=0;t<r.length;t++)e=e*33^r.charCodeAt(t);return(e>>>0).toString(36)}function G(r,e){let t=r.textContent||"",s=`${e.toISOString()}:${t.substring(0,200)}`;return U(s)}var z={threadContainer:"body .thre",responseTimestamp:"body > div.thre table .cnw"};function T(r){return r&&r.nodeType===Node.ELEMENT_NODE?r:null}function ce(r){let e=T(r);return e?e.tagName==="TABLE"?!0:e.tagName==="DIV"&&e.querySelector("table")!==null:!1}function Y(r){return f(r,".cnw")!==null&&f(r,".cno")!==null}function f(r,e){for(let t of r){let n=T(t);if(!n)continue;if(n.matches(e))return n;let s=n.querySelector(e);if(s)return s}return null}function v(r){let e=[],t=[],n=()=>{t.length!==0&&(Y(t)&&e.push(t),t=[])};return r.childNodes.forEach(s=>{if(ce(s)){n(),Y([s])&&e.push([s]);return}t.push(s)}),n(),e}function N(r,e=document){return r.map(t=>e.importNode(t,!0))}function L(r){let e=T(r.querySelector(z.threadContainer));if(e)return e;let t=T(r.querySelector(".thre"));if(t)return t;let n=T(r.querySelector("[data-res]"));if(n)return n;let s=T(r.querySelector(".cnw"));if(s){let i=T(s.closest(".thre"));if(i)return i;let a=T(s.closest("body > div"));if(a)return a}return T(r.body)}function I(r=document){let e=L(r);if(!e)return console.warn("スレッドコンテナが見つかりません"),[];let t=v(e),n=[];return t.forEach((s,i)=>{let a=f(s,".cnw")?.textContent,o=a?fe(a):null;if(!o){console.warn(`レス#${i+1}: タイムスタンプが空です`);return}let l=b(o);if(!l){console.warn(`レス#${i+1}: タイムスタンプ解析に失敗: "${o}"`);return}let d=pe(s);if(!d){console.warn(`レス#${i+1}: アンカー要素が見つかりません`);return}n.push({timestamp:l,element:d,index:i,contentHash:he(s,l,d),allNodes:s})}),n}function pe(r){for(let t of r)if(t.nodeType===Node.ELEMENT_NODE)return t;let e=f(r,".cnw, .cno");return e||null}function he(r,e,t){if(r.length===1&&r[0]instanceof HTMLElement)return G(t,e);let n=me(r),s=e.toISOString();return U(`${s}:${n}`)}function me(r){return r.map(t=>t.textContent??"").join("|").slice(0,200)}function fe(r){let e=r.trim();return e.includes("ID:")?e.split("ID:")[0].trim():e}var ye=1e4,ge=5,C=class{constructor(e={}){this.intervalId=null;this.currentResponses=[];this.options={intervalMs:e.intervalMs??ye,onResponsesAdded:e.onResponsesAdded??(()=>{}),onError:e.onError??(t=>console.error(t))}}start(){if(this.intervalId!==null){console.warn("ResponseUpdateManager is already running");return}try{this.currentResponses=I()}catch(e){this.options.onError(e instanceof Error?e:new Error("Failed to capture initial responses"));return}this.intervalId=window.setInterval(()=>this.update(),this.options.intervalMs)}stop(){this.intervalId!==null&&(window.clearInterval(this.intervalId),this.intervalId=null)}isRunning(){return this.intervalId!==null}getCurrentResponses(){return[...this.currentResponses]}update(){try{let e=I(),t=this.detectAddedResponses(this.currentResponses,e);this.currentResponses=e,t.length>0&&this.options.onResponsesAdded(t)}catch(e){this.options.onError(e instanceof Error?e:new Error("Failed to update responses"))}}detectAddedResponses(e,t){if(t.length<=e.length)return[];let n=Math.min(ge,e.length),s=new Set(e.slice(-n).map(d=>this.makeIdentifier(d))),i=Math.max(0,e.length-n),a=t.slice(i),o=-1;for(let d=0;d<a.length;d++){let u=this.makeIdentifier(a[d]);if(!s.has(u)){o=i+d;break}}if(o===-1||o>=t.length)return t.slice(e.length);let l=Math.max(o,e.length);return t.slice(l)}makeIdentifier(e){return`${e.timestamp.getTime()}-${e.contentHash}`}};function q(r){if(!r)return"utf-8";let e=r.trim().toLowerCase();return e==="shift_jis"||e==="shift-jis"||e==="x-sjis"||e==="x-shift-jis"||e==="windows-31j"?"shift_jis":e||"utf-8"}function Te(r){let e=r.match(/<meta[^>]+charset=["']?([^"'>\s]+)/i);return e?.[1]?e[1]:r.match(/<meta[^>]+http-equiv=["']?content-type["']?[^>]*content=["'][^"']*charset=([^"'>\s]+)/i)?.[1]??null}function ve(r,e){let t=e?.match(/charset=([^;]+)/i)?.[1]??null;if(t)return q(t);let n=Math.min(r.byteLength,4096),s=new TextDecoder("utf-8",{fatal:!1}).decode(new Uint8Array(r,0,n)),i=Te(s);return i?q(i):"utf-8"}async function W(r){let e=await fetch(r);if(!e.ok)throw new Error(`スレッド ${r} を取得できませんでした (status: ${e.status})`);let t=await e.arrayBuffer(),n=ve(t,e.headers.get("content-type")),s;try{s=new TextDecoder(n).decode(t)}catch{s=new TextDecoder("utf-8").decode(t)}return new DOMParser().parseFromString(s,"text/html")}function Z(r){return(r.querySelector("title")?.textContent??"").toLowerCase().includes("futafuta")?"futafuta":Array.from(r.querySelectorAll("script[src]")).some(i=>i.getAttribute("src")?.includes("tsumanne.net"))||Array.from(r.querySelectorAll(".cnw")).some(i=>i.textContent?.includes("ID:"))?"tsumanne":r.querySelector(".thre > div > table")?"futaclo":"futaba"}function j(r,e){switch(e){case"futaba":return Ee(r);case"futaclo":return xe(r);case"tsumanne":return Se(r);case"futafuta":return be(r);default:return[]}}function Ee(r){let e=r.querySelector(".thre");return e?v(e).map(n=>N(n)):[]}function xe(r){let e=r.querySelector(".thre");return e?v(e).map(n=>N(n)):[]}function Se(r){let e=r.querySelector(".thre");return e?v(e).filter(s=>{let i=s.find(a=>a instanceof HTMLElement&&a.tagName==="TABLE");return!(i instanceof HTMLElement&&i.classList.contains("deleted"))}).map(s=>{let i=N(s);return i.forEach(a=>{a instanceof HTMLElement&&Me(a)}),i}):[]}function Me(r){r.querySelectorAll(".cnw").forEach(t=>{let n=t.textContent??"";if(!n.includes("ID:"))return;let s=n.split("ID:")[0].trim();t.textContent=s})}function be(r){let e=r.querySelector(".thre");return e?v(e).map(n=>N(n)):[]}async function J(r,e,t){if(r.length===0)return t.getCurrentResponses();let n=t.isRunning();t.stop(),e.show(r.length);try{let s=await Ne(r,e);Ie(s);let i=I();return n&&t.start(),e.hide(),i}catch(s){let i=s instanceof Error?s.message:"スレッド取得中にエラーが発生しました。";throw e.showError(i),e.hide(),e.destroy(),n&&t.start(),s instanceof Error?s:new Error(i)}}async function Ne(r,e){let t=[];for(let n=0;n<r.length;n+=1){let s=r[n],i=await W(s),a=Z(i),o=j(i,a);t.push(...o),e.updateProgress(n+1,r.length)}return t}function Ie(r){let e=L(document);if(!e)throw new Error("スレッドコンテナが見つかりません。");let t=v(e),n=new Set,s=[];t.forEach(o=>{let l=X(o);l!==null&&n.add(l),s.push({nodes:o,no:l})}),r.forEach(o=>{let l=X(o);l!==null&&n.has(l)||(l!==null&&n.add(l),s.push({nodes:o,no:l}))}),s.sort((o,l)=>o.no===null&&l.no===null?0:o.no===null?1:l.no===null?-1:o.no-l.no);let i=0;s.forEach(o=>{let l=Re(o.nodes),d=we(o.nodes);if(l!==null){i=l;return}if(d!==null){i=d,K(o.nodes,d,!0);return}i+=1,K(o.nodes,i)});let a=s.flatMap(o=>o.nodes);e.replaceChildren(...a)}function X(r){let n=(f(r,".cno")?.textContent??"").match(/No\.(\d+)/);if(!n)return null;let s=Number.parseInt(n[1],10);return Number.isNaN(s)?null:s}function Re(r){let e=f(r,".res_no");if(!e)return null;let t=e.textContent??"",n=Number.parseInt(t,10);return Number.isNaN(n)?null:n}function we(r){let e=f(r,".rsc");if(!e)return null;let t=e.textContent??"",n=Number.parseInt(t,10);return Number.isNaN(n)?null:n}function K(r,e,t=!1){let n=document.createElement("span");n.className="res_no",n.textContent=String(e),t&&(n.style.display="none");let s=f(r,".rtd");if(s){s.insertBefore(n,s.firstChild);return}let i=f(r,".cnw")??f(r,".cno");if(i&&i.parentElement){i.parentElement.insertBefore(n,i);return}if(r.length>0&&r[0]instanceof Element){r[0].insertBefore(n,r[0].firstChild);return}if(r.length>0&&r[0].nodeType===Node.TEXT_NODE){r.splice(1,0,n);return}r.unshift(n)}function A(r,e){if(r.startMode==="index"){let s=r.startResponseIndex;if(!Number.isInteger(s)||s<0)return E({type:"index_out_of_range",message:`レス番号が範囲外です（0〜${Math.max(e.length-1,0)}）`,validRange:{min:0,max:Math.max(e.length-1,0)}});let i=e.find(o=>{let l=Ce(o);return l!==null&&l===s});if(i)return D(i.timestamp);if(s>=e.length)return E({type:"index_out_of_range",message:`レス番号が範囲外です（0〜${Math.max(e.length-1,0)}）`,validRange:{min:0,max:Math.max(e.length-1,0)}});let a=e.find(o=>o.index===s)??e[s];return a?D(a.timestamp):E({type:"index_out_of_range",message:`レス番号が範囲外です（1〜${e.length}）`,validRange:{min:e.length>0?1:0,max:e.length}})}if(r.startMode==="timestamp"){if(typeof r.startValue!="string")return E({type:"timestamp_parse_error",message:"日時形式が不正です（例: 25/11/16(日)22:48:03 または 2025/11/16 22:48:03）",inputValue:String(r.startValue)});let s=b(r.startValue,{skipWeekdayCheck:!0});return s?D(s):E({type:"timestamp_parse_error",message:"日時形式が不正です（例: 25/11/16(日)22:48:03 または 2025/11/16 22:48:03）",inputValue:r.startValue})}let t=Q(r.startValue);if(t===null)return E({type:"no_not_found",message:"指定されたNo.が見つかりません",searchedNo:String(r.startValue)});let n=e.find(s=>{let i=Le(s),a=i?Q(i):null;return a!==null&&a===t});return n?D(n.timestamp):E({type:"no_not_found",message:"指定されたNo.が見つかりません",searchedNo:typeof r.startValue=="string"?r.startValue:`No.${t}`})}function Le(r){let e=r.element.querySelector(".cno")?.textContent?.trim();if(e)return e;if(!r.allNodes)return null;for(let t of r.allNodes)if(t.nodeType===Node.ELEMENT_NODE){let n=t;if(n.classList.contains("cno"))return n.textContent?.trim()??null;let s=n.querySelector(".cno");if(s?.textContent)return s.textContent.trim()}return null}function Q(r){if(typeof r=="number")return Number.isInteger(r)?r:null;let e=r.trim().match(/No\.(\d+)/);if(!e)return null;let t=Number.parseInt(e[1],10);return Number.isNaN(t)?null:t}function Ce(r){let e=r.element.querySelector(".res_no")?.textContent?.trim(),t=e?Number.parseInt(e,10):NaN;if(!Number.isNaN(t))return t;if(r.allNodes){for(let n of r.allNodes)if(n instanceof HTMLElement){let s=n.querySelector(".res_no");if(s?.textContent){let i=Number.parseInt(s.textContent.trim(),10);if(!Number.isNaN(i))return i}}}return null}function D(r){return{success:!0,value:r}}function E(r){return{success:!1,error:r}}function P(r){return{success:!1,error:r}}function ee(r){return{success:!0,value:r}}function te(r){return Number.isFinite(r)?r<=0?P({code:"SPEED_MULTIPLIER_NON_POSITIVE",message:"再生速度は0より大きい数値で指定してください。",input:r}):ee(r):P({code:"SPEED_MULTIPLIER_NOT_FINITE",message:"再生速度は有限の数値で指定してください。",input:r})}function ne(r){let e=r.trim();try{let t=new URL(e);return t.protocol!=="http:"&&t.protocol!=="https:"?P({code:"URL_INVALID_FORMAT",message:"URLは http または https で入力してください。",input:r}):ee(t.toString())}catch{return P({code:"URL_INVALID_FORMAT",message:"有効なURLを入力してください。",input:r})}}var De=1e4,Ae="420px",x="1px solid #444",_=class{constructor(){this.container=null;this.resolveFn=null;this.lastSettings=null}async prompt(e){e();let t=this.lastSettings??this.getDefaultSettings();return this.render(t)}async showWithError(e,t,n){return this.render(e,{message:t,field:n})}destroy(){this.container&&(this.container.remove(),this.container=null),this.resolveFn=null}async render(e,t){if(this.destroy(),!document.body)return null;this.lastSettings=e;let{overlay:n,form:s,errorBox:i}=this.createOverlay(e);return document.body.appendChild(n),t&&this.showError(s,i,t.message,t.field),new Promise(a=>{this.resolveFn=a})}getDefaultSettings(){return{startMode:"index",startValue:0,startResponseIndex:0,speedMultiplier:1,additionalThreadUrls:[],uiMode:"auto-hide"}}createOverlay(e){let t=document.createElement("div");t.dataset.role="input-form-overlay",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.background="rgba(0, 0, 0, 0.6)",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.zIndex=String(De);let n=document.createElement("div");n.dataset.role="input-form-card",n.style.background="#222",n.style.color="#fff",n.style.padding="20px",n.style.borderRadius="8px",n.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.5)",n.style.width=Ae,n.style.fontFamily="sans-serif",n.style.boxSizing="border-box";let s=document.createElement("h2");s.textContent="Futaba Scroller 設定",s.style.margin="0 0 12px",s.style.fontSize="18px";let i=document.createElement("p");i.textContent="開始位置、速度、追加スレッドURLを入力してください。",i.style.margin="0 0 16px",i.style.fontSize="13px",i.style.color="#ddd";let a=document.createElement("form");a.dataset.role="input-form",a.style.display="flex",a.style.flexDirection="column",a.style.gap="12px";let o=this.createStartModeField(e.startMode),l=this.createStartValueField(e),d=this.createSpeedField(e.speedMultiplier),u=this.createUiModeField(e.uiMode),h=this.createAdditionalUrlField(e.additionalThreadUrls),c=this.createErrorBox(),m=this.createActionButtons();a.appendChild(o),a.appendChild(l),a.appendChild(d),a.appendChild(u),a.appendChild(h),a.appendChild(c),a.appendChild(m),a.addEventListener("submit",p=>{p.preventDefault(),this.resetErrorStyles(a,c);let g=this.collectSettings(a);if(!g.success){this.showError(a,c,g.error.message,g.error.field);return}this.lastSettings=g.value,this.resolve(g.value)}),m.querySelector('[data-role="cancel-button"]')?.addEventListener("click",p=>{p.preventDefault(),this.resolve(null)});let R=a.querySelectorAll('input[name="startMode"]'),M=a.querySelector('[data-role="start-value"]');return R.forEach(p=>{p.addEventListener("change",()=>{M&&(M.value=this.getStartValueDefault(p.value),M.placeholder=this.getStartValuePlaceholder(p.value))})}),t.appendChild(n),n.appendChild(s),n.appendChild(i),n.appendChild(a),this.container=t,{overlay:t,form:a,errorBox:c}}createStartModeField(e){let t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.gap="6px";let n=document.createElement("div");n.textContent="開始位置の指定方法",n.style.fontWeight="bold",n.style.fontSize="14px";let s=document.createElement("div");return s.style.display="flex",s.style.gap="12px",[{value:"index",label:"レス番号"},{value:"timestamp",label:"日時"},{value:"no",label:"No."}].forEach(a=>{let o=document.createElement("label");o.style.display="flex",o.style.alignItems="center",o.style.gap="6px",o.style.fontSize="13px";let l=document.createElement("input");l.type="radio",l.name="startMode",l.value=a.value,l.checked=a.value===e,o.appendChild(l),o.appendChild(document.createTextNode(a.label)),s.appendChild(o)}),t.appendChild(n),t.appendChild(s),t}createStartValueField(e){let t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.gap="6px";let n=document.createElement("label");n.textContent="開始位置の値",n.style.fontWeight="bold",n.style.fontSize="14px";let s=document.createElement("input");return s.type="text",s.dataset.role="start-value",s.value=this.getStartValueString(e),s.placeholder=this.getStartValuePlaceholder(e.startMode),s.style.padding="8px",s.style.borderRadius="4px",s.style.border=x,s.style.background="#111",s.style.color="#fff",s.style.fontSize="14px",t.appendChild(n),t.appendChild(s),t}createSpeedField(e){let t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.gap="6px";let n=document.createElement("label");n.textContent="速度倍率",n.style.fontWeight="bold",n.style.fontSize="14px";let s=document.createElement("input");return s.type="number",s.step="0.1",s.min="0.1",s.value=String(e),s.dataset.role="speed",s.style.padding="8px",s.style.borderRadius="4px",s.style.border=x,s.style.background="#111",s.style.color="#fff",s.style.fontSize="14px",t.appendChild(n),t.appendChild(s),t}createUiModeField(e){let t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.gap="6px";let n=document.createElement("div");n.textContent="UI表示モード",n.style.fontWeight="bold",n.style.fontSize="14px";let s=document.createElement("div");return s.style.display="flex",s.style.gap="12px",[{value:"auto-hide",label:"自動非表示（従来）"},{value:"persistent",label:"常駐表示（スマホ向け）"}].forEach(a=>{let o=document.createElement("label");o.style.display="flex",o.style.alignItems="center",o.style.gap="6px",o.style.fontSize="13px";let l=document.createElement("input");l.type="radio",l.name="uiMode",l.value=a.value,l.checked=a.value===e,o.appendChild(l),o.appendChild(document.createTextNode(a.label)),s.appendChild(o)}),t.appendChild(n),t.appendChild(s),t}createAdditionalUrlField(e){let t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.gap="6px";let n=document.createElement("label");n.textContent="追加スレッドURL（改行区切り、任意）",n.style.fontWeight="bold",n.style.fontSize="14px";let s=document.createElement("textarea");return s.rows=4,s.dataset.role="additional-urls",s.placeholder="https://may.2chan.net/b/res/1234567890.htm",s.value=e.join(`
`),s.style.padding="8px",s.style.borderRadius="4px",s.style.border=x,s.style.background="#111",s.style.color="#fff",s.style.fontSize="13px",s.style.resize="vertical",t.appendChild(n),t.appendChild(s),t}createErrorBox(){let e=document.createElement("div");return e.dataset.role="input-error",e.style.display="none",e.style.background="rgba(255, 87, 87, 0.1)",e.style.color="#ff8787",e.style.border="1px solid rgba(255, 87, 87, 0.4)",e.style.padding="8px",e.style.borderRadius="4px",e.style.fontSize="13px",e}createActionButtons(){let e=document.createElement("div");e.style.display="flex",e.style.justifyContent="flex-end",e.style.gap="12px";let t=document.createElement("button");t.type="button",t.textContent="キャンセル",t.dataset.role="cancel-button",t.style.padding="8px 12px",t.style.borderRadius="4px",t.style.border="1px solid #555",t.style.background="#333",t.style.color="#fff",t.style.cursor="pointer";let n=document.createElement("button");return n.type="submit",n.textContent="開始",n.dataset.role="submit-button",n.style.padding="8px 12px",n.style.borderRadius="4px",n.style.border="1px solid #5aa0ff",n.style.background="#2d6bff",n.style.color="#fff",n.style.cursor="pointer",e.appendChild(t),e.appendChild(n),e}collectSettings(e){let t=e.elements.namedItem("startMode"),n="index";(t instanceof RadioNodeList||t instanceof HTMLInputElement)&&(n=t.value||"index");let s=e.elements.namedItem("uiMode"),i="auto-hide";s instanceof RadioNodeList?s.value==="persistent"&&(i="persistent"):s instanceof HTMLInputElement&&s.value==="persistent"&&(i="persistent");let a=e.querySelector('[data-role="start-value"]'),o=e.querySelector('[data-role="speed"]'),l=e.querySelector('[data-role="additional-urls"]');if(!a||!o||!l)return{success:!1,error:{message:"フォーム要素の取得に失敗しました。",field:"startValue"}};let d=a.value.trim(),u=Number(o.value),h=l.value,c=te(u);if(!c.success)return{success:!1,error:{message:c.error.message,field:"speedMultiplier"}};let m=0,y=d;if(n==="index"){let p=Number(d);if(!Number.isInteger(p)||p<0)return{success:!1,error:{message:"レス番号は0以上の整数で入力してください。",field:"startValue"}};m=p,y=p}else if(n==="timestamp"){if(d.length===0)return{success:!1,error:{message:"日時を入力してください。",field:"startValue"}};y=d}else if(n==="no"){if(d.length===0)return{success:!1,error:{message:"No.を入力してください。",field:"startValue"}};y=d}let R=[],M=h.split(/\r?\n/).map(p=>p.trim()).filter(p=>p.length>0);for(let p of M){let g=ne(p);if(!g.success)return{success:!1,error:{message:g.error.message,field:"urls"}};R.push(g.value)}return{success:!0,value:{startMode:n,startValue:y,startResponseIndex:m,speedMultiplier:c.value,additionalThreadUrls:R,uiMode:i}}}showError(e,t,n,s){this.resetErrorStyles(e,t);let i=this.getFieldElement(e,s);i&&(i.style.border="1px solid #ff8787"),t.textContent=n,t.style.display="block"}resetErrorStyles(e,t){t.style.display="none",t.textContent="";let n=this.getFieldElement(e,"startValue"),s=this.getFieldElement(e,"speedMultiplier"),i=this.getFieldElement(e,"urls");n&&(n.style.border=x),s&&(s.style.border=x),i&&(i.style.border=x)}getFieldElement(e,t){return t==="startValue"?e.querySelector('[data-role="start-value"]'):t==="speedMultiplier"?e.querySelector('[data-role="speed"]'):e.querySelector('[data-role="additional-urls"]')}resolve(e){let t=this.resolveFn;this.resolveFn=null,this.destroy(),t?.(e)}getStartValueDefault(e){return e==="timestamp"?"":e==="no"?"No.":"0"}getStartValuePlaceholder(e){return e==="timestamp"?"25/11/16(日)22:48:03 または 2025/11/16 22:48:03":e==="no"?"No.1373341055":"0"}getStartValueString(e){return e.startMode==="index"?String(typeof e.startValue=="number"?e.startValue:e.startResponseIndex??0):typeof e.startValue=="string"?e.startValue:""}};var se="fs-loading-spin",re=!1,H=class{constructor(){this.container=null;this.messageElement=null;this.errorElement=null;this.totalCount=0;this.currentCount=0}show(e){if(this.totalCount=e,this.currentCount=0,this.ensureStyles(),!document.body){console.warn("document.body が見つかりません。");return}this.container||(this.container=this.createContainer(),document.body.appendChild(this.container)),this.updateMessage(),this.container.style.display="flex"}hide(){this.container&&(this.container.style.display="none")}destroy(){this.container&&(this.container.remove(),this.container=null),this.messageElement=null,this.errorElement=null,this.totalCount=0,this.currentCount=0}updateProgress(e,t){Number.isFinite(t)&&(this.totalCount=t),this.currentCount=e,this.updateMessage()}showError(e){this.container||this.show(this.totalCount||0),this.container&&(this.container.style.display="flex"),this.errorElement&&(this.errorElement.textContent=e,this.errorElement.style.display="block")}updateMessage(){if(!this.messageElement)return;let e=this.totalCount>1?` (${this.currentCount}/${this.totalCount})`:"";this.messageElement.textContent=`スレッド取得中...${e}`}createContainer(){let e=document.createElement("div");e.dataset.role="loading-overlay",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.background="rgba(0, 0, 0, 0.6)",e.style.display="none",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex=String(10001);let t=document.createElement("div");t.style.background="#222",t.style.color="#fff",t.style.padding="20px",t.style.borderRadius="8px",t.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.5)",t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="center",t.style.gap="12px",t.style.fontFamily="sans-serif";let n=document.createElement("div");n.dataset.role="loading-spinner",n.style.width="32px",n.style.height="32px",n.style.border="4px solid rgba(255, 255, 255, 0.3)",n.style.borderTop="4px solid #5aa0ff",n.style.borderRadius="50%",n.style.animation=`${se} 1s linear infinite`;let s=document.createElement("div");s.dataset.role="loading-message",s.style.fontSize="14px",s.style.textAlign="center",s.textContent="スレッド取得中...",this.messageElement=s;let i=document.createElement("div");return i.dataset.role="loading-error",i.style.display="none",i.style.color="#ff8787",i.style.fontSize="13px",i.style.textAlign="center",i.style.maxWidth="320px",this.errorElement=i,t.appendChild(n),t.appendChild(s),t.appendChild(i),e.appendChild(t),e}ensureStyles(){if(re||!document.head)return;let e=document.createElement("style");e.textContent=`
@keyframes ${se} {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}`,document.head.appendChild(e),re=!0}};function ie(r){r.scrollIntoView({behavior:"smooth",block:"start"})}var F=class{constructor(){this.container=null;this.hideTimer=null}show(e){if(!this.container){if(!document.body){console.warn("document.body が見つかりません。");return}this.container=this.createContainer(),document.body.appendChild(this.container)}this.container.textContent=`倍速: ${e.toFixed(1)}x`,this.container.style.display="block",this.hideTimer!==null&&window.clearTimeout(this.hideTimer),this.hideTimer=window.setTimeout(()=>{this.hideTimer=null,this.hide()},2e3)}hide(){this.container&&(this.container.style.display="none")}destroy(){this.hideTimer!==null&&(window.clearTimeout(this.hideTimer),this.hideTimer=null),this.container&&(this.container.remove(),this.container=null)}createContainer(){let e=document.createElement("div");return e.dataset.role="speed-overlay",e.style.position="fixed",e.style.top="12px",e.style.left="12px",e.style.padding="8px 12px",e.style.background="rgba(0, 0, 0, 0.7)",e.style.color="#fff",e.style.fontSize="14px",e.style.fontFamily="sans-serif",e.style.borderRadius="4px",e.style.zIndex="9999",e.style.display="none",e.style.pointerEvents="none",e}};var Pe="[再生中] ----/--/-- --:--:-- | 0.0x",_e="24px",He="12px";var k=class{constructor(){this.container=null;this.hasWarnedAboutBody=!1;this.hideTimeoutId=null;this.latestThreadTime=null;this.latestSpeed=0;this.latestPaused=!1}updateState(e,t,n){this.latestThreadTime=e,this.latestSpeed=t,this.latestPaused=n;let s=this.ensureContainer();s&&(s.textContent=this.composeStatusText())}showTemporarily(){let e=this.ensureContainer();e&&(e.textContent=this.composeStatusText(),e.style.display="block",this.clearHideTimer(),this.hideTimeoutId=window.setTimeout(()=>{e.style.display="none",this.hideTimeoutId=null},5e3))}showMessage(e){let t=this.ensureContainer();t&&(t.textContent=e,t.style.display="block",this.clearHideTimer(),this.hideTimeoutId=window.setTimeout(()=>{t.style.display="none",this.hideTimeoutId=null},5e3))}destroy(){this.clearHideTimer(),this.container&&(this.container.remove(),this.container=null),this.latestThreadTime=null,this.hasWarnedAboutBody=!1}ensureContainer(){return document.body?(this.container||(this.container=this.createContainer(),document.body.appendChild(this.container)),this.hasWarnedAboutBody=!1,this.container):(this.hasWarnedAboutBody||(console.warn("document.body が見つかりません"),this.hasWarnedAboutBody=!0),null)}createContainer(){let e=document.createElement("div");return e.dataset.role="status-overlay",e.style.position="fixed",e.style.bottom=_e,e.style.left=He,e.style.padding="8px 12px",e.style.background="rgba(0, 0, 0, 0.7)",e.style.color="#fff",e.style.fontSize="14px",e.style.fontFamily="sans-serif",e.style.borderRadius="4px",e.style.zIndex="9999",e.style.pointerEvents="none",e.style.display="none",e.textContent=Pe,e}composeStatusText(){let e=this.latestPaused?"一時停止中":"再生中",t=this.latestThreadTime?this.formatDate(this.latestThreadTime):"----/--/-- --:--:--";return`[${e}] ${t} | ${this.latestSpeed.toFixed(1)}x`}clearHideTimer(){this.hideTimeoutId!==null&&(window.clearTimeout(this.hideTimeoutId),this.hideTimeoutId=null)}formatDate(e){let t=e.getFullYear().toString().padStart(4,"0"),n=(e.getMonth()+1).toString().padStart(2,"0"),s=e.getDate().toString().padStart(2,"0"),i=e.getHours().toString().padStart(2,"0"),a=e.getMinutes().toString().padStart(2,"0"),o=e.getSeconds().toString().padStart(2,"0");return`${t}/${n}/${s} ${i}:${a}:${o}`}};var ae="background-color 0.15s ease-out, box-shadow 0.2s ease-out, opacity 0.2s ease-out",O=class{constructor(e,t,n){this.onPlayPause=e;this.onSpeedUp=t;this.onSpeedDown=n;this.container=null;this.mainButton=null;this.contentArea=null;this.statusArea=null;this.timeText=null;this.stateRow=null;this.speedText=null;this.playStateText=null;this.messageArea=null;this.controlsArea=null;this.playPauseButton=null;this.speedUpButton=null;this.speedDownButton=null;this.isVisible=!1;this.displayMode="minimized";this.latestThreadTime=null;this.latestSpeed=1;this.latestPaused=!1;this.activeMessage=null;this.isDragging=!1;this.dragMoved=!1;this.dragOffsetX=0;this.dragOffsetY=0;this.dragWidth=0;this.dragHeight=0;this.position=null;this.positionFrame=null;this.boundMove=null;this.boundEnd=null}show(){this.isVisible=!0,this.render()}hide(){this.isVisible=!1,this.container&&(this.container.style.display="none")}destroy(){this.detachDragListeners(),this.container&&(this.container.remove(),this.container=null),this.mainButton=null,this.contentArea=null,this.statusArea=null,this.timeText=null,this.stateRow=null,this.speedText=null,this.playStateText=null,this.messageArea=null,this.controlsArea=null,this.playPauseButton=null,this.speedUpButton=null,this.speedDownButton=null,this.position=null,this.activeMessage=null,this.positionFrame!==null&&(window.cancelAnimationFrame(this.positionFrame),this.positionFrame=null),this.isVisible=!1}updateState(e,t,n){this.latestThreadTime=e,this.latestSpeed=t,this.latestPaused=n,this.render()}showMessage(e,t=!1){this.activeMessage={text:e,isError:t},this.displayMode==="minimized"&&(this.displayMode="status"),this.show()}render(){let e=this.ensureContainer();if(e){if(!this.isVisible){e.style.display="none";return}e.style.display="flex",this.updateLayout(),this.updateTextContent(),this.updateMessageContent(),this.applyPosition()}}ensureContainer(){if(this.container)return this.container;if(!document.body)return console.warn("document.body が見つかりません。"),null;let e=document.createElement("div");e.dataset.role="floating-control",this.applyContainerStyles(e);let t=document.createElement("button");t.type="button",t.dataset.role="display-toggle",t.textContent="⚡",this.applyMainButtonStyles(t),t.addEventListener("click",()=>{if(this.dragMoved){this.dragMoved=!1;return}this.cycleDisplayMode()}),this.mainButton=t;let n=document.createElement("div");n.dataset.role="content-area",this.applyContentAreaStyles(n),this.contentArea=n;let s=document.createElement("div");s.dataset.role="status-area",this.applyStatusAreaStyles(s),this.statusArea=s;let i=document.createElement("div");i.dataset.role="time-text",this.applyTimeTextStyles(i),this.timeText=i;let a=document.createElement("div");a.dataset.role="state-row",this.applyStateRowStyles(a),this.stateRow=a;let o=document.createElement("span");o.dataset.role="speed-text",this.speedText=o;let l=document.createElement("span");l.dataset.role="play-state-text",this.playStateText=l,a.appendChild(o),a.appendChild(l),s.appendChild(i),s.appendChild(a);let d=document.createElement("div");d.dataset.role="message-area",this.applyMessageAreaStyles(d),this.messageArea=d;let u=document.createElement("div");u.dataset.role="controls-area",this.applyControlsAreaStyles(u),this.controlsArea=u;let h=document.createElement("button");h.type="button",h.dataset.role="play-pause",h.textContent="⏸",this.applyControlButtonStyles(h),h.addEventListener("click",()=>{this.onPlayPause()}),this.playPauseButton=h;let c=document.createElement("button");c.type="button",c.dataset.role="speed-down",c.textContent="－",this.applyControlButtonStyles(c),c.addEventListener("click",()=>{this.onSpeedDown()}),this.speedDownButton=c;let m=document.createElement("button");return m.type="button",m.dataset.role="speed-up",m.textContent="＋",this.applyControlButtonStyles(m),m.addEventListener("click",()=>{this.onSpeedUp()}),this.speedUpButton=m,u.appendChild(h),u.appendChild(c),u.appendChild(m),n.appendChild(s),n.appendChild(d),n.appendChild(u),e.appendChild(t),e.appendChild(n),e.addEventListener("touchstart",y=>this.handleDragStart(y),{passive:!1}),e.addEventListener("mousedown",y=>this.handleDragStart(y)),document.body.appendChild(e),this.container=e,e}applyContainerStyles(e){e.style.position="fixed",e.style.display="flex",e.style.flexDirection="row",e.style.alignItems="center",e.style.gap="8px",e.style.padding="12px",e.style.background="rgba(22, 24, 28, 0.95)",e.style.color="#e8eaed",e.style.borderRadius="12px",e.style.boxShadow="0 4px 16px rgba(0, 0, 0, 0.4)",e.style.fontFamily='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',e.style.zIndex=String(12e3),e.style.userSelect="none",e.style.cursor="grab",e.style.transition=ae}updateContainerTransition(e){this.container&&(this.container.style.transition=e?ae:"none")}applyMainButtonStyles(e){e.style.width="48px",e.style.height="48px",e.style.flexShrink="0",e.style.alignSelf="flex-start",e.style.borderRadius="50%",e.style.border="none",e.style.background="rgba(76, 158, 255, 0.25)",e.style.color="#4c9eff",e.style.fontSize="20px",e.style.cursor="pointer",e.style.transition="background-color 0.15s ease",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.addEventListener("mouseenter",()=>{e.style.background="rgba(76, 158, 255, 0.35)"}),e.addEventListener("mouseleave",()=>{e.style.background="rgba(76, 158, 255, 0.25)"})}applyContentAreaStyles(e){e.style.display="flex",e.style.flexDirection="column",e.style.gap="8px",e.style.minWidth="0"}applyStatusAreaStyles(e){e.style.display="flex",e.style.flexDirection="column",e.style.gap="4px",e.style.fontSize="13px",e.style.lineHeight="1.4"}applyTimeTextStyles(e){e.style.color="#e8eaed"}applyStateRowStyles(e){e.style.display="flex",e.style.flexDirection="row",e.style.gap="12px",e.style.fontSize="12px",e.style.color="#9aa0a6"}applyMessageAreaStyles(e){e.style.display="none",e.style.fontSize="12px",e.style.lineHeight="1.4",e.style.padding="8px",e.style.marginTop="6px",e.style.borderRadius="6px",e.style.background="rgba(255, 255, 255, 0.06)",e.style.color="#e8eaed"}applyControlsAreaStyles(e){e.style.display="none",e.style.flexDirection="row",e.style.gap="6px",e.style.alignItems="center",e.style.marginTop="4px",e.style.paddingTop="8px",e.style.borderTop="1px solid rgba(255, 255, 255, 0.1)"}applyControlButtonStyles(e){e.style.width="44px",e.style.height="44px",e.style.borderRadius="8px",e.style.border="none",e.style.background="rgba(76, 158, 255, 0.15)",e.style.color="#4c9eff",e.style.fontSize="18px",e.style.cursor="pointer",e.style.transition="background-color 0.15s ease",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.addEventListener("mouseenter",()=>{e.style.background="rgba(76, 158, 255, 0.25)"}),e.addEventListener("mouseleave",()=>{e.style.background="rgba(76, 158, 255, 0.15)"})}cycleDisplayMode(){this.displayMode==="minimized"?this.displayMode="status":this.displayMode==="status"?this.displayMode="full":this.displayMode="minimized",this.render()}updateLayout(){!this.container||!this.contentArea||!this.controlsArea||(this.displayMode==="minimized"?(this.container.style.width="60px",this.container.style.height="60px",this.container.style.padding="12px 0 0 12px",this.container.style.justifyContent="flex-start",this.container.style.alignItems="flex-start",this.contentArea.style.display="none"):(this.container.style.width="280px",this.container.style.height="auto",this.container.style.padding="12px",this.container.style.justifyContent="flex-start",this.container.style.alignItems="flex-start",this.contentArea.style.display="flex",this.displayMode==="full"?this.controlsArea.style.display="flex":this.controlsArea.style.display="none"))}updateTextContent(){if(this.timeText){let e=this.latestThreadTime?this.formatDate(this.latestThreadTime):"----/--/-- --:--:--";this.timeText.textContent=e}if(this.speedText&&(this.speedText.textContent=`速度: ${this.latestSpeed.toFixed(1)}x`),this.playStateText){let e=this.latestPaused?"⏸":"▶",t=this.latestPaused?"一時停止中":"再生中";this.playStateText.textContent=`${e} ${t}`}this.playPauseButton&&(this.playPauseButton.textContent=this.latestPaused?"▶":"⏸")}updateMessageContent(){if(this.messageArea){if(!this.activeMessage){this.messageArea.style.display="none";return}this.messageArea.style.display="block",this.messageArea.textContent=this.activeMessage.text,this.activeMessage.isError?(this.messageArea.style.background="rgba(255, 107, 107, 0.15)",this.messageArea.style.color="#ff6b6b"):(this.messageArea.style.background="rgba(255, 255, 255, 0.06)",this.messageArea.style.color="#e8eaed")}}handleDragStart(e){if(!this.container||e instanceof MouseEvent&&e.button!==0)return;let t=e.target;if(t instanceof HTMLButtonElement&&!t.matches('[data-role="display-toggle"]'))return;let n=this.getClientCoordinates(e),s=this.container.getBoundingClientRect();this.dragWidth=s.width,this.dragHeight=s.height,this.dragOffsetX=n.x-s.left,this.dragOffsetY=n.y-s.top,this.isDragging=!0,this.dragMoved=!1,this.updateContainerTransition(!1),this.container.style.cursor="grabbing",this.bindDragListeners(),e.preventDefault()}handleDragMove(e){if(!this.isDragging||!this.container)return;let t=this.getClientCoordinates(e),n=this.dragWidth||this.container.getBoundingClientRect().width||48,s=this.dragHeight||this.container.getBoundingClientRect().height||48,i=Math.max(12,window.innerWidth-n-12),a=Math.max(12,window.innerHeight-s-12),o=t.x-this.dragOffsetX,l=t.y-this.dragOffsetY;o=Math.min(Math.max(12,o),i),l=Math.min(Math.max(12,l),a),this.position?(this.position.x=o,this.position.y=l):this.position={x:o,y:l},this.dragMoved=!0,this.schedulePositionApply(),e.preventDefault()}handleDragEnd(){this.isDragging&&(this.isDragging=!1,this.detachDragListeners(),this.updateContainerTransition(!0),this.container&&(this.container.style.cursor="grab"),this.dragWidth=0,this.dragHeight=0)}bindDragListeners(){this.detachDragListeners(),this.boundMove=e=>this.handleDragMove(e),this.boundEnd=()=>this.handleDragEnd(),window.addEventListener("touchmove",this.boundMove,{passive:!1}),window.addEventListener("touchend",this.boundEnd),window.addEventListener("touchcancel",this.boundEnd),window.addEventListener("mousemove",this.boundMove),window.addEventListener("mouseup",this.boundEnd)}detachDragListeners(){this.boundMove&&(window.removeEventListener("touchmove",this.boundMove),window.removeEventListener("mousemove",this.boundMove),this.boundMove=null),this.boundEnd&&(window.removeEventListener("touchend",this.boundEnd),window.removeEventListener("touchcancel",this.boundEnd),window.removeEventListener("mouseup",this.boundEnd),this.boundEnd=null)}schedulePositionApply(){this.positionFrame===null&&(this.positionFrame=window.requestAnimationFrame(()=>{this.positionFrame=null,this.applyPosition()}))}applyPosition(){if(!this.container)return;let e=this.dragWidth||this.container.getBoundingClientRect().width||48,t=this.dragHeight||this.container.getBoundingClientRect().height||48,n=window.innerWidth-e-12,s=window.innerHeight-t-12;if(!this.position)this.position={x:Math.max(12,n),y:Math.max(12,s)};else{let i=Math.max(12,window.innerWidth-e-12),a=Math.max(12,window.innerHeight-t-12);this.position.x=Math.min(Math.max(12,this.position.x),i),this.position.y=Math.min(Math.max(12,this.position.y),a)}this.container.style.left=`${this.position.x}px`,this.container.style.top=`${this.position.y}px`}formatDate(e){let t=e.getFullYear().toString().padStart(4,"0"),n=(e.getMonth()+1).toString().padStart(2,"0"),s=e.getDate().toString().padStart(2,"0"),i=e.getHours().toString().padStart(2,"0"),a=e.getMinutes().toString().padStart(2,"0"),o=e.getSeconds().toString().padStart(2,"0");return`${t}/${n}/${s} ${i}:${a}:${o}`}getClientCoordinates(e){if(typeof TouchEvent<"u"&&e instanceof TouchEvent){let n=e.touches[0]??e.changedTouches[0];return{x:n?.clientX??0,y:n?.clientY??0}}let t=e;return{x:t.clientX,y:t.clientY}}};var Fe=500,ke=.1,Oe=10,B=.1;var V=class{constructor(e,t,n,s=ie,i){this.responses=e;this.settings=t;this.timeline=n;this.scrollFn=s;this.onError=i;this.intervalId=null;this.executionStartMs=null;this.baselineThreadTime=null;this.floatingControl=null;this.keydownHandler=null;this.playbackState="STOPPED";this.currentThreadTime=null;this.startThreadTime=null;this.hasScrolledInitial=!1;this.lastResponseTimestamp=null;this.timelineEnded=!1;this.timelineResponses=e.map(a=>({timestamp:a.timestamp,index:a.index})),this.responseMap=new Map(e.map(a=>[a.index,a])),this.isPersistentMode=t.uiMode==="persistent",this.speedOverlay=this.isPersistentMode?null:new F,this.statusOverlay=this.isPersistentMode?null:new k,this.isPersistentMode&&(this.floatingControl=this.createFloatingControlPanel()),this.speedMultiplier=t.speedMultiplier,this.lastResponseTimestamp=this.getLastResponseTimestamp()}start(e={}){this.intervalId!==null&&this.stop(),this.isPersistentMode&&!this.floatingControl&&(this.floatingControl=this.createFloatingControlPanel());let t=e.startTime?{success:!0,value:e.startTime}:A(this.settings,this.responses);if(!t.success){console.error(t.error.message),this.onError?.(t.error.message);return}this.startThreadTime=t.value,this.currentThreadTime=t.value,this.executionStartMs=e.startPaused?null:Date.now(),this.baselineThreadTime=null,this.speedMultiplier=this.settings.speedMultiplier,this.hasScrolledInitial=!1,this.timelineEnded=!1,this.playbackState=e.startPaused?"PAUSED":"PLAYING",this.updateStatusOverlay(!0),this.isPersistentMode&&this.floatingControl?.show(),e.startPaused&&this.showStatusMessage("準備完了、xキーでスクロール開始"),this.lastResponseTimestamp=this.getLastResponseTimestamp(),this.tick(),this.intervalId=window.setInterval(()=>this.tick(),Fe),this.bindKeyboard()}stop(){this.intervalId!==null&&(window.clearInterval(this.intervalId),this.intervalId=null),this.executionStartMs=null,this.baselineThreadTime=null,this.unbindKeyboard(),this.speedOverlay?.destroy(),this.statusOverlay?.destroy(),this.cleanupFloatingControl(),this.playbackState="STOPPED",this.currentThreadTime=null,this.startThreadTime=null,this.hasScrolledInitial=!1,this.timelineEnded=!1}isRunning(){return this.playbackState!=="STOPPED"&&!this.timelineEnded}tick(){if(!this.startThreadTime)return;if(this.playbackState!=="PAUSED"&&this.executionStartMs!==null){let n={threadStartTime:this.startThreadTime,executionStartMs:this.executionStartMs,speedMultiplier:this.speedMultiplier,baselineThreadTime:this.baselineThreadTime??void 0},s=this.timeline.getCurrentThreadTime(n,Date.now());this.currentThreadTime=s}else this.currentThreadTime||(this.currentThreadTime=this.startThreadTime);if(this.updateStatusOverlay(),!this.currentThreadTime)return;if(this.lastResponseTimestamp&&this.currentThreadTime.getTime()>this.lastResponseTimestamp.getTime()){this.handleTimelineEnd();return}if(this.playbackState==="PAUSED"||this.executionStartMs===null)return;let e=this.timeline.findPreviousResponse(this.timelineResponses,this.currentThreadTime);if(!e)return;if(!this.hasScrolledInitial&&this.settings.startMode==="index"){let n=this.responseMap.get(this.settings.startResponseIndex);if(n){this.scrollFn(n.element),this.hasScrolledInitial=!0;return}}let t=this.responseMap.get(e.index);if(!t){console.error(`レス番号${e.index}に対応する要素が見つかりません。`);return}this.scrollFn(t.element)}handleTimelineEnd(){if(this.timelineEnded)return;this.timelineEnded=!0;let e=this.responses.length>0?this.responses[this.responses.length-1]:null;e&&(this.currentThreadTime=e.timestamp,this.scrollFn(e.element)),this.intervalId!==null&&(window.clearInterval(this.intervalId),this.intervalId=null),this.executionStartMs=null,this.playbackState="PAUSED",this.updateStatusOverlay(!0),this.showStatusMessage("タイムライン終了"),this.unbindKeyboard()}bindKeyboard(){this.keydownHandler&&window.removeEventListener("keydown",this.keydownHandler),this.keydownHandler=e=>{let t=e.target;if(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement||t instanceof HTMLSelectElement||t instanceof HTMLElement&&t.isContentEditable)return;let n=e.key.toLowerCase();n==="d"?this.adjustSpeed(B):n==="s"?this.adjustSpeed(-B):n==="x"&&this.togglePause()},window.addEventListener("keydown",this.keydownHandler)}unbindKeyboard(){this.keydownHandler&&(window.removeEventListener("keydown",this.keydownHandler),this.keydownHandler=null)}adjustSpeed(e){if(this.executionStartMs===null&&this.playbackState!=="PAUSED")return;let t=Number((this.speedMultiplier+e).toFixed(1)),n=Math.min(Oe,Math.max(ke,t));if(n===this.speedMultiplier||!this.startThreadTime)return;if(this.playbackState==="PAUSED"||this.executionStartMs===null){this.speedMultiplier=n,this.isPersistentMode||this.speedOverlay?.show(this.speedMultiplier),this.updateStatusOverlay(!0);return}let s={threadStartTime:this.startThreadTime,executionStartMs:this.executionStartMs,speedMultiplier:this.speedMultiplier,baselineThreadTime:this.baselineThreadTime??void 0},i=this.timeline.getCurrentThreadTime(s,Date.now());this.baselineThreadTime=i,this.currentThreadTime=i,this.executionStartMs=Date.now(),this.speedMultiplier=n,this.isPersistentMode||this.speedOverlay?.show(this.speedMultiplier),this.updateStatusOverlay(!0)}pause(){if(this.playbackState==="PLAYING"&&this.startThreadTime){if(this.executionStartMs!==null){let e={threadStartTime:this.startThreadTime,executionStartMs:this.executionStartMs,speedMultiplier:this.speedMultiplier,baselineThreadTime:this.baselineThreadTime??void 0},t=this.timeline.getCurrentThreadTime(e,Date.now());this.baselineThreadTime=t,this.currentThreadTime=t}this.executionStartMs=null,this.playbackState="PAUSED",this.updateStatusOverlay(!0)}}resume(){this.playbackState==="PAUSED"&&(this.executionStartMs=Date.now(),this.playbackState="PLAYING",this.updateStatusOverlay(!0))}togglePause(){this.playbackState==="PAUSED"?this.resume():this.pause()}updateStatusOverlay(e=!1){if(this.isPersistentMode){this.floatingControl?.updateState(this.currentThreadTime,this.speedMultiplier,this.playbackState==="PAUSED");return}this.statusOverlay?.updateState(this.currentThreadTime,this.speedMultiplier,this.playbackState==="PAUSED"),e&&this.statusOverlay?.showTemporarily()}showStatusMessage(e){this.isPersistentMode?this.floatingControl?.showMessage(e):this.statusOverlay?.showMessage(e)}createFloatingControlPanel(){return new O(()=>this.togglePause(),()=>this.adjustSpeed(B),()=>this.adjustSpeed(-B))}cleanupFloatingControl(){this.floatingControl&&(this.floatingControl.destroy(),this.floatingControl=null)}getLastResponseTimestamp(){if(this.responses.length===0)return null;let e=this.responses[0].timestamp;for(let t of this.responses)t.timestamp.getTime()>e.getTime()&&(e=t.timestamp);return e}appendResponses(e){if(e.length===0)return;this.responses.push(...e);let t=e.map(n=>({timestamp:n.timestamp,index:n.index}));this.timelineResponses.push(...t);for(let n of e)this.responseMap.set(n.index,n);this.lastResponseTimestamp=this.getLastResponseTimestamp()}};var S=class extends Error{};async function oe(){let r=new _,e=new H,t=null,n=null;try{n=new C({intervalMs:1e4,onResponsesAdded:a=>{t&&t.appendResponses(a)},onError:a=>{console.error("レス更新エラー:",a)}}),n.start();let s=n.getCurrentResponses();if(s.length===0)throw n.stop(),new S("レスが見つかりませんでした。");let i=await r.prompt(()=>n?n.getCurrentResponses().length:s.length);for(;i;){let a=n.getCurrentResponses();if(i.additionalThreadUrls.length>0)try{a=await J(i.additionalThreadUrls,e,n)}catch(u){n.stop();let h=u instanceof Error?u.message:"スレッドの取得に失敗しました。";throw new S(h)}if(a.length===0)throw n.stop(),new S("レスが見つかりませんでした。");let o=A(i,a);if(!o.success){i=await r.showWithError(i,o.error.message,"startValue");continue}let l=new w,d=n.getCurrentResponses();return t=new V(i.additionalThreadUrls.length>0?a:d,i,l,void 0,u=>window.alert(u)),t.start({startPaused:!0,startTime:o.value}),{controller:t,updateManager:n}}return n.stop(),null}catch(s){return n?.stop(),s instanceof S?(window.alert(s.message),null):(console.error("予期しないエラーが発生しました。",s),window.alert("エラーが発生しました。コンソールを確認してください。"),null)}}(async function(){window.__FUTABA_SCROLLER__&&(window.__FUTABA_SCROLLER__.controller.stop(),window.__FUTABA_SCROLLER__.updateManager.stop());let e=await oe();e&&(window.__FUTABA_SCROLLER__=e)})().catch(r=>{console.error("FutabaScroller起動エラー:",r)});})();
